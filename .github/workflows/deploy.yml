name: Deploy to Production

on:
  push:
    branches:
      - preprod
  workflow_dispatch: ~

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

jobs:
  pull-env:
    name: Pull Environment Variables
    uses: ./.github/workflows/deploy-env.yml
    if: github.ref == 'refs/heads/preprod'
    secrets: inherit

  build-and-push:
    name: Build and Push Docker Image
    needs: pull-env
    uses: ./.github/workflows/deploy-build.yml
    if: always() && (needs.pull-env.result == 'success' || needs.pull-env.result == 'skipped')
    with:
      env-artifact-name: env-production
      has-env-artifact: ${{ needs.pull-env.result == 'success' }}
    secrets: inherit

  deploy:
    name: Deploy to Server
    needs: [build-and-push, pull-env]
    uses: ./.github/workflows/deploy-server.yml
    if: github.ref == 'refs/heads/preprod' && needs.build-and-push.result == 'success'
    with:
      image-tag: preprod
    secrets: inherit

  summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [pull-env, build-and-push, deploy]
    if: always()
    steps:
      - name: Generate deployment summary
        run: |
          echo "# ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Job Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Pull Environment | ${{ needs.pull-env.result == 'success' && 'âœ… Success' || needs.pull-env.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build and Push | ${{ needs.build-and-push.result == 'success' && 'âœ… Success' || needs.build-and-push.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy to Server | ${{ needs.deploy.result == 'success' && 'âœ… Success' || needs.deploy.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "### âœ… Deployment Successful!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The application has been successfully deployed to the server." >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Deployment Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please check the job logs for more details." >> $GITHUB_STEP_SUMMARY
          fi
