name: Deploy to Production

on:
  push:
    branches:
      - preprod
  workflow_dispatch: ~

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build-and-push:
    name: Build and Push Docker Image
    uses: ./.github/workflows/deploy-build.yml
    if: github.ref == 'refs/heads/preprod'
    secrets: inherit

  deploy:
    name: Deploy to Server
    needs: build-and-push
    uses: ./.github/workflows/deploy-server.yml
    if: github.ref == 'refs/heads/preprod' && needs.build-and-push.result == 'success'
    with:
      image-tag: preprod
    secrets: inherit

  summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [build-and-push, deploy]
    if: always()
    steps:
      - name: Generate deployment summary
        run: |
          BUILD_RESULT="${{ needs.build-and-push.result }}"
          if [ "$BUILD_RESULT" == "success" ]; then
            BUILD_STATUS="✅ Success"
          elif [ "$BUILD_RESULT" == "skipped" ]; then
            BUILD_STATUS="⏭️ Skipped"
          else
            BUILD_STATUS="❌ Failed"
          fi
          
          DEPLOY_RESULT="${{ needs.deploy.result }}"
          if [ "$DEPLOY_RESULT" == "success" ]; then
            DEPLOY_STATUS="✅ Success"
          elif [ "$DEPLOY_RESULT" == "skipped" ]; then
            DEPLOY_STATUS="⏭️ Skipped"
          else
            DEPLOY_STATUS="❌ Failed"
          fi
