name: Deploy - Server Deployment

on:
  workflow_call:
    inputs:
      image-tag:
        description: "Docker image tag to deploy"
        required: false
        type: string
        default: preprod
  workflow_dispatch:
    inputs:
      image-tag:
        description: "Docker image tag to deploy"
        required: false
        type: string
        default: preprod

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Copy Docker configuration to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          source: "compose.yaml,compose.prod.yaml,frankenphp,scripts"
          target: "joypharma/"
          overwrite: true

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          timeout: 60s
          command_timeout: 15m
          script: |
            set -euo pipefail
            cd joypharma || exit 1
            
            # ============================================
            # 1. Docker Hub Authentication
            # ============================================
            echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin || exit 1

            # ============================================
            # 2. Image Configuration
            # ============================================
            IMAGE_TAG="${{ inputs.image-tag }}"
            IMAGE_TAG="${IMAGE_TAG:-preprod}"
            export IMAGE_NAME="${{ secrets.DOCKERHUB_USERNAME }}/joy-pharma-back:${IMAGE_TAG}"
            export IMAGES_PREFIX="${{ secrets.DOCKERHUB_USERNAME }}/"
            
            # ============================================
            # 3. Traefik Network Detection
            # ============================================
            TRAEFIK_NETWORK=""
            
            # Method 1: Check Traefik container and get its network
            if docker ps -a --format '{{.Names}}' | grep -qE "^traefik$|^traefik-"; then
              TRAEFIK_CONTAINER=$(docker ps -a --format '{{.Names}}' | grep -E "^traefik$|^traefik-" | head -n1)
              TRAEFIK_NETWORK=$(docker inspect "$TRAEFIK_CONTAINER" --format '{{range $net, $conf := .NetworkSettings.Networks}}{{$net}}{{end}}' 2>/dev/null | head -n1 || echo "")
            fi
            
            # Method 2: Check common Traefik network names
            if [ -z "$TRAEFIK_NETWORK" ]; then
              for NET_NAME in traefik traefik_default traefik_proxy traefik_web; do
                if docker network inspect "$NET_NAME" &>/dev/null 2>&1; then
                  TRAEFIK_NETWORK="$NET_NAME"
                  break
                fi
              done
            fi
            
            # Method 3: Find network by pattern (most common)
            if [ -z "$TRAEFIK_NETWORK" ]; then
              TRAEFIK_NETWORK=$(docker network ls --format '{{.Name}}' | grep -iE "^traefik|traefik$" | head -n1 || echo "")
            fi
            
            # Method 4: Check networks connected to Traefik container
            if [ -z "$TRAEFIK_NETWORK" ] && [ -n "$TRAEFIK_CONTAINER" ]; then
              TRAEFIK_NETWORK=$(docker inspect "$TRAEFIK_CONTAINER" --format '{{range $net, $conf := .NetworkSettings.Networks}}{{$net}}{{end}}' 2>/dev/null | grep -v "^bridge$" | head -n1 || echo "")
            fi
            
            # Fallback: Create default network if Traefik not found
            if [ -z "$TRAEFIK_NETWORK" ]; then
              NETWORK_NAME="joy-pharma-back_default"
              if ! docker network inspect "$NETWORK_NAME" &>/dev/null 2>&1; then
                docker network create "$NETWORK_NAME" || exit 1
              fi
              TRAEFIK_NETWORK="$NETWORK_NAME"
            fi
            
            # Verify network exists and is accessible
            if ! docker network inspect "$TRAEFIK_NETWORK" &>/dev/null 2>&1; then
              exit 1
            fi
            
            export TRAEFIK_NETWORK
            
            # ============================================
            # 4. Infisical CLI Installation
            # ============================================
            if ! command -v infisical &>/dev/null; then
              curl -1sLf 'https://dl.cloudsmith.io/public/infisical/infisical-cli/setup.deb.sh' | sudo -E bash || exit 1
              sudo apt-get update && sudo apt-get install -y infisical || exit 1
            fi
            
            # ============================================
            # 5. Generate .env from Infisical
            # ============================================
            INFISICAL_TOKEN=$(infisical login \
              --method=universal-auth \
              --client-id="${{ secrets.INFISICAL_CLIENT_ID }}" \
              --client-secret="${{ secrets.INFISICAL_CLIENT_SECRET }}" \
              --domain="${{ secrets.INFISICAL_DOMAIN }}" \
              --silent \
              --plain) || exit 1
            
            if [ -z "$INFISICAL_TOKEN" ]; then
              exit 1
            fi
            
            # Export secrets from Infisical
            infisical export \
              --token="$INFISICAL_TOKEN" \
              --domain="${{ secrets.INFISICAL_DOMAIN }}" \
              --projectId="${{ secrets.INFISICAL_PROJECTID }}" \
              --env=prod \
              --format=dotenv > .env || exit 1
            
            if [ ! -s .env ]; then
              exit 1
            fi
            
            # ============================================
            # 6. Add Docker and Deployment Variables
            # ============================================
            {
              echo ""
              echo "# Docker Configuration"
              echo "INFISICAL_TOKEN=$INFISICAL_TOKEN"
              echo "INFISICAL_PROJECT_ID=${{ secrets.INFISICAL_PROJECTID }}"
              echo "IMAGES_PREFIX=${{ secrets.DOCKERHUB_USERNAME }}/"
              echo "IMAGE_TAG=${IMAGE_TAG}"
              echo "TRAEFIK_NETWORK=$TRAEFIK_NETWORK"
            } >> .env
            
            # Ensure critical variables are set
            if ! grep -q "^APP_ENV=" .env; then
              echo "APP_ENV=prod" >> .env
            fi
            
            if ! grep -q "^SERVER_NAME=" .env; then
              echo "SERVER_NAME=${{ secrets.SERVER_NAME }}" >> .env
            fi
            
            # Export for docker compose
            export INFISICAL_TOKEN
            export INFISICAL_PROJECT_ID="${{ secrets.INFISICAL_PROJECTID }}"
            export IMAGE_NAME
            export TRAEFIK_NETWORK
            
            # ============================================
            # 7. Verify Configuration Files
            # ============================================
            if [ ! -f compose.yaml ] || [ ! -f compose.prod.yaml ]; then
              exit 1
            fi
            
            # ============================================
            # 8. Backup Current Deployment
            # ============================================
            CURRENT_CONTAINER=""
            if [ -f compose.yaml ] && [ -f .env ]; then
              CURRENT_CONTAINER=$(docker compose -f compose.yaml -f compose.prod.yaml --env-file .env ps -q php 2>/dev/null || echo "")
            fi
            
            # ============================================
            # 9. Pull Docker Images with Retry
            # ============================================
            MAX_RETRIES=3
            RETRY_COUNT=0
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              if docker compose -f compose.yaml -f compose.prod.yaml --env-file .env pull; then
                break
              fi
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                sleep 5
              fi
            done
            
            if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
              exit 1
            fi
            
            # ============================================
            # 10. Cleanup Old Containers
            # ============================================
            # Stop existing containers
            docker compose -f compose.yaml -f compose.prod.yaml --env-file .env down 2>/dev/null || true
            
            # Remove containers with conflicting Traefik labels
            CONFLICTING_CONTAINERS=$(docker ps -a --format "{{.ID}}\t{{.Names}}" | while read -r id name; do
              if docker inspect "$id" --format '{{range $k, $v := .Config.Labels}}{{$k}}={{$v}}{{"\n"}}{{end}}' 2>/dev/null | grep -q "traefik.http.routers.joy-pharma-back"; then
                echo "$id"
              fi
            done || echo "")
            
            if [ -n "$CONFLICTING_CONTAINERS" ]; then
              echo "$CONFLICTING_CONTAINERS" | xargs -r docker stop 2>/dev/null || true
              echo "$CONFLICTING_CONTAINERS" | xargs -r docker rm 2>/dev/null || true
            fi
            
            # Stop containers using port 80
            CONTAINERS_ON_80=$(docker ps --filter "publish=80" --format "{{.ID}}" 2>/dev/null || echo "")
            if [ -n "$CONTAINERS_ON_80" ]; then
              echo "$CONTAINERS_ON_80" | xargs -r docker stop 2>/dev/null || true
            fi
            
            # Remove fixed name container
            if docker ps -a --filter "name=^joy-pharma-back-php$" --format "{{.ID}}" | grep -q .; then
              docker stop joy-pharma-back-php 2>/dev/null || true
              docker rm joy-pharma-back-php 2>/dev/null || true
            fi
            
            # Wait for ports to be released
            sleep 3
            
            # ============================================
            # 11. Deploy New Version
            # ============================================
            if ! docker compose -f compose.yaml -f compose.prod.yaml --env-file .env up -d; then
              docker compose -f compose.yaml -f compose.prod.yaml --env-file .env ps -a
              docker compose -f compose.yaml -f compose.prod.yaml --env-file .env logs
              exit 1
            fi
            
            # Wait for services to start
            sleep 10
            
            # ============================================
            # 12. Verify Container Status
            # ============================================
            PHP_CONTAINER=$(docker compose -f compose.yaml -f compose.prod.yaml --env-file .env ps -q php 2>/dev/null || echo "")
            
            if [ -z "$PHP_CONTAINER" ]; then
              docker compose -f compose.yaml -f compose.prod.yaml --env-file .env logs php
              exit 1
            fi
            
            # Check container health
            sleep 5
            CONTAINER_STATUS=$(docker inspect --format='{{.State.Status}}' "$PHP_CONTAINER" 2>/dev/null || echo "unknown")
            RESTART_COUNT=$(docker inspect --format='{{.RestartCount}}' "$PHP_CONTAINER" 2>/dev/null || echo "0")
            
            if [ "$CONTAINER_STATUS" != "running" ] || [ "$RESTART_COUNT" != "0" ]; then
              docker compose -f compose.yaml -f compose.prod.yaml --env-file .env logs php --tail 100
              # Attempt rollback
              if [ -n "$CURRENT_CONTAINER" ] && docker ps -a --format '{{.ID}}' | grep -q "$CURRENT_CONTAINER"; then
                docker compose -f compose.yaml -f compose.prod.yaml --env-file .env down
                docker start "$CURRENT_CONTAINER"
              else
                docker compose -f compose.yaml -f compose.prod.yaml --env-file .env down
              fi
              exit 1
            fi
            
            # ============================================
            # 13. Database Health Check
            # ============================================
            MAX_DB_WAIT=30
            DB_WAIT=0
            until docker compose -f compose.yaml -f compose.prod.yaml --env-file .env exec -T database pg_isready -U app 2>/dev/null || [ $DB_WAIT -eq $MAX_DB_WAIT ]; do
              DB_WAIT=$((DB_WAIT + 1))
              sleep 2
            done
            
            if [ $DB_WAIT -eq $MAX_DB_WAIT ]; then
              exit 1
            fi
            
            # ============================================
            # 14. Application Setup
            # ============================================
            # Verify PHP container is ready
            if ! docker compose -f compose.yaml -f compose.prod.yaml --env-file .env exec -T php php -v > /dev/null 2>&1; then
              docker compose -f compose.yaml -f compose.prod.yaml --env-file .env logs php --tail 50
              exit 1
            fi
            
            # Verify database connection
            if ! docker compose -f compose.yaml -f compose.prod.yaml --env-file .env exec -T php bin/console dbal:run-sql "SELECT 1" > /dev/null 2>&1; then
              exit 1
            fi
            
            # Generate JWT keys
            docker compose -f compose.yaml -f compose.prod.yaml --env-file .env exec -T php bin/console lexik:jwt:generate-keypair --overwrite --no-interaction || true
            
            # Clear and warmup cache
            docker compose -f compose.yaml -f compose.prod.yaml --env-file .env exec -T php bin/console cache:clear --no-warmup || true
            docker compose -f compose.yaml -f compose.prod.yaml --env-file .env exec -T php bin/console cache:warmup || true
            
            # ============================================
            # 15. Final Health Check
            # ============================================
            sleep 3
            if ! docker compose -f compose.yaml -f compose.prod.yaml --env-file .env exec -T php php -v > /dev/null 2>&1; then
              exit 1
            fi
            
            # Verify Traefik labels are applied
            TRAEFIK_LABELS=$(docker inspect "$PHP_CONTAINER" --format '{{range $k, $v := .Config.Labels}}{{$k}}={{$v}}{{"\n"}}{{end}}' 2>/dev/null | grep -c "traefik" || echo "0")
            if [ "$TRAEFIK_LABELS" -eq "0" ]; then
              exit 1
            fi
            
            # Verify container is on Traefik network
            if ! docker inspect "$PHP_CONTAINER" --format '{{range $net, $conf := .NetworkSettings.Networks}}{{$net}}{{end}}' 2>/dev/null | grep -q "$TRAEFIK_NETWORK"; then
              exit 1
            fi
            
            # Cleanup old images
            docker image prune -f || true
            
            # Show final status
            docker compose -f compose.yaml -f compose.prod.yaml --env-file .env ps
