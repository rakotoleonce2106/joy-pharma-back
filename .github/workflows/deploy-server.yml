name: Deploy - Server Deployment

on:
  workflow_call:
    inputs:
      image-tag:
        description: "Docker image tag to deploy"
        required: false
        type: string
        default: preprod
  workflow_dispatch:
    inputs:
      image-tag:
        description: "Docker image tag to deploy"
        required: false
        type: string
        default: preprod

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Copy compose.yaml to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          source: "compose.yaml"
          target: "joypharma/"
          overwrite: true

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          timeout: 60s
          command_timeout: 15m
          script: |
            set -e
            cd joypharma
            
            echo "============================================"
            echo "Starting deployment process..."
            echo "============================================"
            
            # Login to Docker Hub
            echo "→ Logging in to Docker Hub..."
            echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

            # Determine the image tag to use
            IMAGE_TAG="${{ inputs.image-tag }}"
            if [ -z "$IMAGE_TAG" ]; then
              IMAGE_TAG="preprod"
            fi
            
            export IMAGE_NAME="${{ secrets.DOCKERHUB_USERNAME }}/joy-pharma-back:${IMAGE_TAG}"
            echo "→ Using image: $IMAGE_NAME"
            
            # Find Traefik network
            echo "→ Detecting Traefik network..."
            TRAEFIK_NETWORK=$(docker inspect traefik --format '{{range $net, $conf := .NetworkSettings.Networks}}{{$net}}{{end}}' 2>/dev/null | head -n1)
            
            if [ -z "$TRAEFIK_NETWORK" ]; then
                echo "⚠ Warning: Could not find Traefik network. Creating default network."
                NETWORK_NAME="joy-pharma-back_default"
                if ! docker network inspect $NETWORK_NAME &>/dev/null; then
                    docker network create $NETWORK_NAME
                    echo "✓ Created network: $NETWORK_NAME"
                else
                    echo "✓ Network already exists: $NETWORK_NAME"
                fi
                export TRAEFIK_NETWORK=$NETWORK_NAME
            else
                echo "✓ Found Traefik network: $TRAEFIK_NETWORK"
                export TRAEFIK_NETWORK
            fi
            
            # Install Infisical CLI on the server
            echo "→ Installing Infisical CLI on server..."
            if ! command -v infisical &> /dev/null; then
                curl -1sLf 'https://dl.cloudsmith.io/public/infisical/infisical-cli/setup.deb.sh' | sudo -E bash
                sudo apt-get update && sudo apt-get install -y infisical
                echo "✓ Infisical installed successfully"
            else
                echo "✓ Infisical already installed"
            fi
            
            # Generate .env file using Infisical
            echo "→ Generating .env file from Infisical..."
            INFISICAL_TOKEN=$(infisical login --method=universal-auth --client-id="${{ secrets.INFISICAL_CLIENT_ID }}" --client-secret="${{ secrets.INFISICAL_CLIENT_SECRET }}" --domain="${{ secrets.INFISICAL_DOMAIN }}" --silent --plain)
            
            if [ -z "$INFISICAL_TOKEN" ]; then
                echo "✗ Failed to generate Infisical token"
                exit 1
            fi
            
            echo "✓ Infisical token generated successfully"
            
            # Export environment variables to .env file
            infisical export --token=$INFISICAL_TOKEN --domain="${{ secrets.INFISICAL_DOMAIN }}" --projectId="${{ secrets.INFISICAL_PROJECTID }}" --env=prod > .env
            
            if [ ! -s .env ]; then
                echo "✗ Failed to generate .env file or file is empty"
                exit 1
            fi
            
            # Add INFISICAL_TOKEN, INFISICAL_PROJECT_ID, IMAGE_NAME and TRAEFIK_NETWORK to .env for docker compose
            # These are needed by compose.yaml but may not be in the Infisical export
            echo "INFISICAL_TOKEN=$INFISICAL_TOKEN" >> .env
            echo "INFISICAL_PROJECT_ID=${{ secrets.INFISICAL_PROJECTID }}" >> .env
            echo "IMAGE_NAME=$IMAGE_NAME" >> .env
            echo "TRAEFIK_NETWORK=$TRAEFIK_NETWORK" >> .env
            
            # Export variables for docker compose commands (as backup)
            export INFISICAL_TOKEN
            export INFISICAL_PROJECT_ID="${{ secrets.INFISICAL_PROJECTID }}"
            export IMAGE_NAME
            export TRAEFIK_NETWORK
            
            echo "✓ .env file generated successfully"
            echo "→ Verifying .env file contents..."
            echo "INFISICAL_TOKEN found: $(grep -c '^INFISICAL_TOKEN=' .env || echo '0')"
            echo "INFISICAL_PROJECT_ID found: $(grep -c '^INFISICAL_PROJECT_ID=' .env || echo '0')"
            echo "TRAEFIK_NETWORK found: $(grep -c '^TRAEFIK_NETWORK=' .env || echo '0')"
            echo "→ Verifying .env file exists and is readable..."
            if [ ! -f .env ]; then
                echo "✗ .env file does not exist!"
                exit 1
            fi
            echo "✓ .env file exists ($(wc -l < .env) lines)"
            echo "→ Showing first few lines of .env (without sensitive values)..."
            head -n 5 .env | sed 's/=.*/=***/' || echo "Could not read .env file"
            
            # Backup current container for rollback
            echo "→ Backing up current deployment..."
            CURRENT_CONTAINER=$(docker compose --env-file .env ps -q php 2>/dev/null || echo "")
            if [ -n "$CURRENT_CONTAINER" ]; then
                echo "✓ Current container ID: $CURRENT_CONTAINER"
            else
                echo "ℹ No existing container to backup"
            fi
            
            # Pull new image with retry logic
            echo "→ Pulling Docker image (with retry)..."
            MAX_RETRIES=3
            RETRY_COUNT=0
            until docker compose --env-file .env pull || [ $RETRY_COUNT -eq $MAX_RETRIES ]; do
                RETRY_COUNT=$((RETRY_COUNT+1))
                echo "⚠ Pull failed. Retry $RETRY_COUNT/$MAX_RETRIES..."
                sleep 5
            done
            
            if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
                echo "✗ Failed to pull image after $MAX_RETRIES attempts"
                exit 1
            fi
            
            echo "✓ Image pulled successfully"
            
            # Deploy new version
            echo "→ Deploying new version..."
            if docker compose --env-file .env up -d; then
                echo "✓ Containers started"
                
                # Wait for container to be healthy
                echo "→ Waiting for container to stabilize..."
                sleep 5
                
                NEW_CONTAINER=$(docker compose --env-file .env ps -q php 2>/dev/null || echo "")
                if [ -n "$NEW_CONTAINER" ]; then
                    # Check container status multiple times to catch restart loops
                    sleep 5
                    CONTAINER_STATUS=$(docker inspect --format='{{.State.Status}}' $NEW_CONTAINER 2>/dev/null || echo "unknown")
                    RESTART_COUNT=$(docker inspect --format='{{.RestartCount}}' $NEW_CONTAINER 2>/dev/null || echo "0")
                    
                    echo "→ Container status: $CONTAINER_STATUS (restart count: $RESTART_COUNT)"
                    
                    if [ "$CONTAINER_STATUS" = "running" ] && [ "$RESTART_COUNT" = "0" ]; then
                        echo "✓ Container is running and healthy"
                        
                        # Verify .env file is mounted correctly
                        echo "→ Verifying .env file in container..."
                        docker exec $NEW_CONTAINER test -f /app/.env && echo "✓ .env file is mounted" || echo "⚠ .env file not found in container"
                        
                        # Clean up old images
                        echo "→ Cleaning up old images..."
                        docker image prune -f
                        
                        echo "============================================"
                        echo "✓ Deployment completed successfully!"
                        echo "============================================"
                    else
                        echo "✗ Container is not running properly (status: $CONTAINER_STATUS, restarts: $RESTART_COUNT)"
                        echo "→ Checking container logs..."
                        docker logs $NEW_CONTAINER --tail 100 2>&1 || echo "Could not retrieve logs"
                        echo "→ Checking container exit code..."
                        EXIT_CODE=$(docker inspect --format='{{.State.ExitCode}}' $NEW_CONTAINER 2>/dev/null || echo "unknown")
                        echo "Exit code: $EXIT_CODE"
                        echo "→ Attempting rollback..."
                        if [ -n "$CURRENT_CONTAINER" ] && docker ps -a --format '{{.ID}}' | grep -q "$CURRENT_CONTAINER"; then
                            docker compose --env-file .env down
                            docker start $CURRENT_CONTAINER
                            echo "✓ Rollback completed"
                        else
                            echo "⚠ No previous container to rollback to"
                            docker compose --env-file .env down
                        fi
                        exit 1
                    fi
                else
                    echo "✗ Failed to get new container ID"
                    echo "→ Checking all containers..."
                    docker compose --env-file .env ps -a
                    exit 1
                fi
            else
                echo "✗ Deployment failed"
                echo "→ Checking compose status..."
                docker compose --env-file .env ps -a
                exit 1
            fi
