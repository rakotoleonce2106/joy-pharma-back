name: Deploy - Server Deployment

on:
  workflow_call:
    inputs:
      image-tag:
        description: "Docker image tag to deploy"
        required: false
        type: string
        default: preprod
  workflow_dispatch:
    inputs:
      image-tag:
        description: "Docker image tag to deploy"
        required: false
        type: string
        default: preprod

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Préparer le répertoire de déploiement
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          timeout: 60s
          command_timeout: 5m
          script: |
            set -euo pipefail
            DEPLOY_PATH="${{ secrets.DEPLOY_PATH }}"
            DEPLOY_PATH="${DEPLOY_PATH/#\~/$HOME}"
            if [ -z "$DEPLOY_PATH" ]; then
              exit 1
            fi
            mkdir -p "$DEPLOY_PATH/joypharma"

      - name: Copy Docker configuration to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          source: "compose.yaml,compose.prod.yaml,frankenphp,scripts"
          target: "${{ secrets.DEPLOY_PATH }}/joypharma/"
          overwrite: true

      - name: Mask image-tag input
        run: |
          echo "::add-mask::${{ inputs.image-tag }}"

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          timeout: 60s
          command_timeout: 15m
          script: |
            set -euo pipefail
            DEPLOY_PATH="${{ secrets.DEPLOY_PATH }}"
            DEPLOY_PATH="${DEPLOY_PATH/#\~/$HOME}"
            if [ -z "$DEPLOY_PATH" ]; then
              exit 1
            fi
            cd "$DEPLOY_PATH/joypharma" || exit 1
            
            # ============================================
            # 1. Docker Hub Authentication
            # ============================================
            echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin || exit 1

            # ============================================
            # 2. Image Configuration
            # ============================================
            IMAGE_TAG="${{ inputs.image-tag }}"
            IMAGE_TAG="${IMAGE_TAG:-preprod}"
            export IMAGE_NAME="${{ secrets.DOCKERHUB_USERNAME }}/joy-pharma-back:${IMAGE_TAG}"
            export IMAGES_PREFIX="${{ secrets.DOCKERHUB_USERNAME }}/"
            
            # Traefik is already configured on the server, no network detection needed
            
            # ============================================
            # 4. Infisical CLI Installation
            # ============================================
            if ! command -v infisical &>/dev/null; then
              curl -1sLf 'https://dl.cloudsmith.io/public/infisical/infisical-cli/setup.deb.sh' | sudo -E bash || exit 1
              sudo apt-get update && sudo apt-get install -y infisical || exit 1
            fi
            
            # ============================================
            # 5. Generate .env from Infisical
            # ============================================
            INFISICAL_TOKEN=$(infisical login \
              --method=universal-auth \
              --client-id="${{ secrets.INFISICAL_CLIENT_ID }}" \
              --client-secret="${{ secrets.INFISICAL_CLIENT_SECRET }}" \
              --domain="${{ secrets.INFISICAL_DOMAIN }}" \
              --silent \
              --plain) || exit 1
            
            if [ -z "$INFISICAL_TOKEN" ]; then
              exit 1
            fi
            
            # Export secrets from Infisical
            infisical export \
              --token="$INFISICAL_TOKEN" \
              --domain="${{ secrets.INFISICAL_DOMAIN }}" \
              --projectId="${{ secrets.INFISICAL_PROJECTID }}" \
              --env=prod \
              --format=dotenv > .env || exit 1
            
            if [ ! -s .env ]; then
              exit 1
            fi
            
            # ============================================
            # 6. Add Docker and Deployment Variables
            # ============================================
            {
              echo ""
              echo "# Docker Configuration"
              echo "INFISICAL_TOKEN=$INFISICAL_TOKEN"
              echo "INFISICAL_PROJECT_ID=${{ secrets.INFISICAL_PROJECTID }}"
              echo "IMAGES_PREFIX=${{ secrets.DOCKERHUB_USERNAME }}/"
              echo "IMAGE_TAG=${IMAGE_TAG}"
            } >> .env
            
            # Ensure critical variables are set
            if ! grep -q "^APP_ENV=" .env; then
              echo "APP_ENV=prod" >> .env
            fi
            
            if ! grep -q "^SERVER_NAME=" .env; then
              echo "SERVER_NAME=${{ secrets.SERVER_NAME }}" >> .env
            fi
            
            # Export for docker compose
            export INFISICAL_TOKEN
            export INFISICAL_PROJECT_ID="${{ secrets.INFISICAL_PROJECTID }}"
            export IMAGE_NAME
            
            # ============================================
            # 7. Verify Configuration Files
            # ============================================
            if [ ! -f compose.yaml ] || [ ! -f compose.prod.yaml ]; then
              exit 1
            fi
            
            # ============================================
            # 8. Backup Current Deployment
            # ============================================
            CURRENT_CONTAINER=""
            if [ -f compose.yaml ] && [ -f .env ]; then
              CURRENT_CONTAINER=$(docker compose -f compose.yaml -f compose.prod.yaml --env-file .env ps -q php 2>/dev/null || echo "")
            fi
            
            # ============================================
            # 9. Pull Docker Images with Retry
            # ============================================
            MAX_RETRIES=3
            RETRY_COUNT=0
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              if docker compose -f compose.yaml -f compose.prod.yaml --env-file .env pull; then
                break
              fi
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                sleep 5
              fi
            done
            
            if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
              exit 1
            fi
            
            # ============================================
            # 10. Cleanup Old Containers
            # ============================================
            # Stop existing containers
            docker compose -f compose.yaml -f compose.prod.yaml --env-file .env down 2>/dev/null || true
            
            # Stop containers using port 80
            CONTAINERS_ON_80=$(docker ps --filter "publish=80" --format "{{.ID}}" 2>/dev/null || echo "")
            if [ -n "$CONTAINERS_ON_80" ]; then
              echo "$CONTAINERS_ON_80" | xargs -r docker stop 2>/dev/null || true
            fi
            
            # Remove fixed name container
            if docker ps -a --filter "name=^joy-pharma-back-php$" --format "{{.ID}}" | grep -q .; then
              docker stop joy-pharma-back-php 2>/dev/null || true
              docker rm joy-pharma-back-php 2>/dev/null || true
            fi
            
            # Wait for ports to be released
            sleep 3
            
            # ============================================
            # 11. Deploy New Version
            # ============================================
            if ! docker compose -f compose.yaml -f compose.prod.yaml --env-file .env up -d; then
              docker compose -f compose.yaml -f compose.prod.yaml --env-file .env ps -a
              docker compose -f compose.yaml -f compose.prod.yaml --env-file .env logs
              exit 1
            fi
            
            # Wait for services to start
            sleep 10
            
            # ============================================
            # 12. Verify Container Status
            # ============================================
            PHP_CONTAINER=$(docker compose -f compose.yaml -f compose.prod.yaml --env-file .env ps -q php 2>/dev/null || echo "")
            
            if [ -z "$PHP_CONTAINER" ]; then
              docker compose -f compose.yaml -f compose.prod.yaml --env-file .env logs php
              exit 1
            fi
            
            # Check container health
            sleep 5
            CONTAINER_STATUS=$(docker inspect --format='{{.State.Status}}' "$PHP_CONTAINER" 2>/dev/null || echo "unknown")
            RESTART_COUNT=$(docker inspect --format='{{.RestartCount}}' "$PHP_CONTAINER" 2>/dev/null || echo "0")
            
            if [ "$CONTAINER_STATUS" != "running" ] || [ "$RESTART_COUNT" != "0" ]; then
              docker compose -f compose.yaml -f compose.prod.yaml --env-file .env logs php --tail 100
              # Attempt rollback
              if [ -n "$CURRENT_CONTAINER" ] && docker ps -a --format '{{.ID}}' | grep -q "$CURRENT_CONTAINER"; then
                docker compose -f compose.yaml -f compose.prod.yaml --env-file .env down
                docker start "$CURRENT_CONTAINER"
              else
                docker compose -f compose.yaml -f compose.prod.yaml --env-file .env down
              fi
              exit 1
            fi
            
            # ============================================
            # 13. Database Health Check
            # ============================================
            MAX_DB_WAIT=30
            DB_WAIT=0
            until docker compose -f compose.yaml -f compose.prod.yaml --env-file .env exec -T database pg_isready -U app 2>/dev/null || [ $DB_WAIT -eq $MAX_DB_WAIT ]; do
              DB_WAIT=$((DB_WAIT + 1))
              sleep 2
            done
            
            if [ $DB_WAIT -eq $MAX_DB_WAIT ]; then
              exit 1
            fi
            
            # ============================================
            # 14. Application Setup
            # ============================================
            # Verify PHP container is ready
            if ! docker compose -f compose.yaml -f compose.prod.yaml --env-file .env exec -T php php -v > /dev/null 2>&1; then
              docker compose -f compose.yaml -f compose.prod.yaml --env-file .env logs php --tail 50
              exit 1
            fi
            
            # Verify database connection
            if ! docker compose -f compose.yaml -f compose.prod.yaml --env-file .env exec -T php bin/console dbal:run-sql "SELECT 1" > /dev/null 2>&1; then
              exit 1
            fi
            
            # Generate JWT keys
            docker compose -f compose.yaml -f compose.prod.yaml --env-file .env exec -T php bin/console lexik:jwt:generate-keypair --overwrite --no-interaction || true
            
            # Clear and warmup cache
            docker compose -f compose.yaml -f compose.prod.yaml --env-file .env exec -T php bin/console cache:clear --no-warmup || true
            docker compose -f compose.yaml -f compose.prod.yaml --env-file .env exec -T php bin/console cache:warmup || true
            
            # ============================================
            # 15. Final Health Check
            # ============================================
            sleep 3
            if ! docker compose -f compose.yaml -f compose.prod.yaml --env-file .env exec -T php php -v > /dev/null 2>&1; then
              exit 1
            fi
            
            # Cleanup old images
            docker image prune -f || true
            
            # Show final status
            docker compose -f compose.yaml -f compose.prod.yaml --env-file .env ps
