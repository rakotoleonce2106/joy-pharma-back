name: Deploy - Server Deployment

on:
  workflow_call:
    inputs:
      image-tag:
        description: "Docker image tag to deploy"
        required: false
        type: string
        default: preprod
  workflow_dispatch:
    inputs:
      image-tag:
        description: "Docker image tag to deploy"
        required: false
        type: string
        default: preprod

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Copy compose.yaml to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          source: "compose.yaml"
          target: "joypharma/"
          overwrite: true

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          timeout: 60s
          command_timeout: 15m
          script: |
            set -e
            cd joypharma
            
            echo "============================================"
            echo "Starting deployment process..."
            echo "============================================"
            
            # Login to Docker Hub
            echo "→ Logging in to Docker Hub..."
            echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

            # Determine the image tag to use
            IMAGE_TAG="${{ inputs.image-tag }}"
            if [ -z "$IMAGE_TAG" ]; then
              IMAGE_TAG="preprod"
            fi
            
            export IMAGE_NAME="${{ secrets.DOCKERHUB_USERNAME }}/joy-pharma-back:${IMAGE_TAG}"
            echo "→ Using image: $IMAGE_NAME"
            
            # Find Traefik network
            echo "→ Detecting Traefik network..."
            export TRAEFIK_NETWORK=$(docker inspect traefik --format '{{range $net, $conf := .NetworkSettings.Networks}}{{$net}}{{end}}' 2>/dev/null | head -n1)
            
            if [ -z "$TRAEFIK_NETWORK" ]; then
                echo "⚠ Warning: Could not find Traefik network. Using default network."
            else
                echo "✓ Found Traefik network: $TRAEFIK_NETWORK"
            fi
            
            # Set Infisical credentials for runtime secret injection
            echo "→ Configuring Infisical credentials..."
            export INFISICAL_CLIENT_ID="${{ secrets.INFISICAL_CLIENT_ID }}"
            export INFISICAL_CLIENT_SECRET="${{ secrets.INFISICAL_CLIENT_SECRET }}"
            export INFISICAL_PROJECT_ID="${{ secrets.INFISICAL_PROJECT_ID }}"
            export INFISICAL_ENV_SLUG="${{ secrets.INFISICAL_ENV_SLUG }}"
            
            # Generate Infisical token for container
            echo "→ Generating Infisical access token..."
            # Check if infisical is available in the image
            echo "→ Checking Infisical installation in image..."
            INFISICAL_PATH=$(docker run --rm --entrypoint="" $IMAGE_NAME /bin/bash -c "command -v infisical 2>/dev/null || which infisical 2>/dev/null || echo ''")
            
            if [ -z "$INFISICAL_PATH" ]; then
                echo "✗ Error: infisical command not found in Docker image"
                echo "→ Checking common installation locations..."
                docker run --rm --entrypoint="" $IMAGE_NAME /bin/bash -c "
                    echo 'Checking /usr/bin/infisical:'
                    ls -la /usr/bin/infisical 2>&1 || echo '  Not found'
                    echo 'Checking /usr/local/bin/infisical:'
                    ls -la /usr/local/bin/infisical 2>&1 || echo '  Not found'
                    echo 'Checking PATH:'
                    echo \$PATH
                    echo 'Checking all infisical binaries:'
                    find /usr -name infisical 2>/dev/null || echo '  Not found'
                "
                echo "⚠ The image may not have been built with Infisical installed."
                echo "⚠ Please ensure the Dockerfile includes Infisical installation in the frankenphp_base stage."
                exit 1
            else
                echo "✓ Found Infisical at: $INFISICAL_PATH"
            fi
            
            # Generate token using Infisical (should be in PATH if found above)
            echo "→ Generating Infisical access token..."
            export INFISICAL_TOKEN=$(docker run --rm \
              -e INFISICAL_CLIENT_ID="$INFISICAL_CLIENT_ID" \
              -e INFISICAL_CLIENT_SECRET="$INFISICAL_CLIENT_SECRET" \
              --entrypoint="" \
              $IMAGE_NAME \
              /bin/bash -c "infisical login --method=universal-auth \
                --client-id=\"$INFISICAL_CLIENT_ID\" \
                --client-secret=\"$INFISICAL_CLIENT_SECRET\" \
                --plain --silent")
            
            if [ -z "$INFISICAL_TOKEN" ]; then
                echo "✗ Failed to generate Infisical token"
                exit 1
            fi
            
            echo "✓ Infisical token generated successfully"
            
            # Backup current container for rollback
            echo "→ Backing up current deployment..."
            CURRENT_CONTAINER=$(docker compose ps -q php 2>/dev/null || echo "")
            if [ -n "$CURRENT_CONTAINER" ]; then
                echo "✓ Current container ID: $CURRENT_CONTAINER"
            else
                echo "ℹ No existing container to backup"
            fi
            
            # Pull new image with retry logic
            echo "→ Pulling Docker image (with retry)..."
            MAX_RETRIES=3
            RETRY_COUNT=0
            until docker compose pull || [ $RETRY_COUNT -eq $MAX_RETRIES ]; do
                RETRY_COUNT=$((RETRY_COUNT+1))
                echo "⚠ Pull failed. Retry $RETRY_COUNT/$MAX_RETRIES..."
                sleep 5
            done
            
            if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
                echo "✗ Failed to pull image after $MAX_RETRIES attempts"
                exit 1
            fi
            
            echo "✓ Image pulled successfully"
            
            # Deploy new version
            echo "→ Deploying new version..."
            if docker compose up -d; then
                echo "✓ Deployment successful"
                
                # Wait for container to be healthy
                echo "→ Waiting for health check..."
                sleep 10
                
                NEW_CONTAINER=$(docker compose ps -q php 2>/dev/null || echo "")
                if [ -n "$NEW_CONTAINER" ]; then
                    CONTAINER_STATUS=$(docker inspect --format='{{.State.Status}}' $NEW_CONTAINER)
                    if [ "$CONTAINER_STATUS" = "running" ]; then
                        echo "✓ Container is running and healthy"
                        
                        # Clean up old images
                        echo "→ Cleaning up old images..."
                        docker image prune -f
                        
                        echo "============================================"
                        echo "✓ Deployment completed successfully!"
                        echo "============================================"
                    else
                        echo "✗ Container is not running (status: $CONTAINER_STATUS)"
                        echo "→ Attempting rollback..."
                        if [ -n "$CURRENT_CONTAINER" ]; then
                            docker compose down
                            docker start $CURRENT_CONTAINER
                            echo "✓ Rollback completed"
                        fi
                        exit 1
                    fi
                else
                    echo "✗ Failed to get new container ID"
                    exit 1
                fi
            else
                echo "✗ Deployment failed"
                exit 1
            fi
