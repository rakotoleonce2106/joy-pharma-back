name: Deploy Backend

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      tag:
        description: "Docker image tag to deploy (leave empty for auto-generated)"
        required: false
        type: string

jobs:
  build-and-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    outputs:
      image-tag: ${{ steps.generate_tag.outputs.image_tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Generate version tag with timestamp
        id: generate_tag
        run: |
          # Format: v1.YYYYMMDD.HHmmss (ex: v1.20241217.143025)
          TIMESTAMP=$(date -u +"%Y%m%d.%H%M%S")
          VERSION="v1.${TIMESTAMP}"
          
          # Cr√©er les tags
          IMAGE_NAME="${{ secrets.DOCKERHUB_USERNAME }}/joy-pharma-back"
          TAGS="${IMAGE_NAME}:${VERSION},${IMAGE_NAME}:latest"
          
          echo "image_tag=${VERSION}" >> $GITHUB_OUTPUT
          echo "docker_tags=${TAGS}" >> $GITHUB_OUTPUT
          echo "üì¶ Version g√©n√©r√©e: ${VERSION}"
          echo "üè∑Ô∏è  Tags Docker: ${TAGS}"

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.generate_tag.outputs.docker_tags }}
          cache-from: type=gha,scope=build-backend
          cache-to: type=gha,mode=max,scope=build-backend
          platforms: linux/amd64

  deploy:
    name: Deploy to Server
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine image tag
        id: tag
        run: |
          if [ -n "${{ github.event.inputs.tag }}" ]; then
            TAG="${{ github.event.inputs.tag }}"
            echo "üìå Using manual tag: ${TAG}"
          else
            TAG="${{ needs.build-and-push.outputs.image-tag }}"
            echo "ü§ñ Using auto-generated tag: ${TAG}"
          fi
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "üè∑Ô∏è  Final tag: ${TAG}"

      - name: Prepare server directory
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          port: ${{ secrets.SSH_PORT }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            mkdir -p ~/joy-pharma-back
            echo "üè∑Ô∏è  Image tag to deploy: ${{ steps.tag.outputs.tag }}" > ~/joy-pharma-back/deployment_info.txt
            echo "üìÖ Deployment time: $(date)" >> ~/joy-pharma-back/deployment_info.txt

      - name: Copy files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          port: ${{ secrets.SSH_PORT }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "deploy.sh,compose.yaml,compose.prod.yaml"
          target: "~/joy-pharma-back"
          overwrite: true

      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        env:
          IMAGE_TAG: ${{ steps.tag.outputs.tag }}
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
          INFISICAL_CLIENT_ID: ${{ secrets.INFISICAL_CLIENT_ID }}
          INFISICAL_CLIENT_SECRET: ${{ secrets.INFISICAL_CLIENT_SECRET }}
          INFISICAL_DOMAIN: ${{ secrets.INFISICAL_DOMAIN }}
          INFISICAL_PROJECTID: ${{ secrets.INFISICAL_PROJECTID }}
        with:
          host: ${{ secrets.SSH_HOST }}
          port: ${{ secrets.SSH_PORT }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: IMAGE_TAG,DOCKERHUB_USERNAME,DOCKERHUB_TOKEN,INFISICAL_CLIENT_ID,INFISICAL_CLIENT_SECRET,INFISICAL_DOMAIN,INFISICAL_PROJECTID
          script: |
            set -e
            cd ~/joy-pharma-back
            
            echo "üöÄ D√©ploiement du backend avec le tag: ${IMAGE_TAG}"
            
            # Installer ou mettre √† jour Infisical CLI
            curl -1sLf 'https://artifacts-cli.infisical.com/setup.deb.sh' | sudo -E bash
            sudo apt-get update && sudo apt-get install -y infisical
            
            # G√©n√©rer le token Infisical
            INFISICAL_TOKEN=$(infisical login --method=universal-auth --client-id="${INFISICAL_CLIENT_ID}" --client-secret="${INFISICAL_CLIENT_SECRET}" --domain="${INFISICAL_DOMAIN}" --silent --plain)
            
            if [ -z "$INFISICAL_TOKEN" ]; then
              echo "‚ùå √âchec de la g√©n√©ration du token Infisical"
              exit 1
            fi
            
            # Exporter les variables d'environnement depuis Infisical vers .env
            infisical export \
              --token="$INFISICAL_TOKEN" \
              --domain="${INFISICAL_DOMAIN}" \
              --projectId="${INFISICAL_PROJECTID}" \
              --env=prod \
              --format=dotenv > .env
            
            if [ ! -s .env ]; then
              echo "‚ùå √âchec de la g√©n√©ration du fichier .env ou fichier vide"
              exit 1
            fi
            
            # Ajouter les variables Docker avec le tag g√©n√©r√©
            {
              echo ""
              echo "# Docker Configuration"
              echo "DOCKERHUB_USERNAME=${DOCKERHUB_USERNAME}"
              echo "TAG=${IMAGE_TAG}"
            } >> .env
            
            # Exporter les variables pour docker compose
            export TAG="${IMAGE_TAG}"
            export DOCKERHUB_USERNAME="${DOCKERHUB_USERNAME}"
            
            # V√©rifier que les variables critiques sont pr√©sentes
            if ! grep -q "^POSTGRES_USER=" .env || ! grep -q "^POSTGRES_PASSWORD=" .env || ! grep -q "^POSTGRES_DB=" .env; then
              echo "‚ö† Attention: Variables POSTGRES_* manquantes dans .env"
            fi
            
            if ! grep -q "^APP_SECRET=" .env; then
              echo "‚ö† Attention: APP_SECRET manquant dans .env"
            fi
            
            # Authentifier Docker Hub
            echo "‚Üí Authentification Docker Hub..."
            echo "${DOCKERHUB_TOKEN}" | docker login -u "${DOCKERHUB_USERNAME}" --password-stdin
            
            # Rendre deploy.sh ex√©cutable
            chmod +x deploy.sh
            
            # Ex√©cuter le script de d√©ploiement
            echo "‚Üí Ex√©cution du script de d√©ploiement..."
            bash deploy.sh
            
            echo "‚úÖ D√©ploiement termin√© avec succ√®s!"
            echo "üì¶ Image d√©ploy√©e: ${DOCKERHUB_USERNAME}/joy-pharma-back:${IMAGE_TAG}"

      - name: Verify deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          port: ${{ secrets.SSH_PORT }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd ~/joy-pharma-back
            
            echo "üîç V√©rification du d√©ploiement..."
            
            # V√©rifier que les containers sont en cours d'ex√©cution
            docker compose ps
            
            # Afficher les images d√©ploy√©es
            echo ""
            echo "üì¶ Images actuellement d√©ploy√©es:"
            docker compose images
            
            # Afficher les derniers logs
            echo ""
            echo "üìã Derniers logs (20 lignes):"
            docker compose logs --tail=20