# docker-compose.yml pour le serveur de production
# À copier dans /joy-pharma-back/docker-compose.yml sur le serveur

version: '3.8'

services:
  php:
    image: ${DOCKER_IMAGE}
    container_name: joy-pharma-backend
    
    # Montage des données persistantes (images, uploads)
    # Ces dossiers sont HORS du projet et ne sont jamais supprimés lors des déploiements
    volumes:
      - /joy-pharma-data/images:/app/public/images:rw
      - /joy-pharma-data/media:/app/public/media:rw
      - /joy-pharma-data/uploads:/app/public/uploads:rw
    
    # Connexion aux réseaux
    networks:
      - traefik-network      # Pour Traefik (reverse proxy)
      - infrastructure_default  # Pour PostgreSQL
    
    # Variables d'environnement
    environment:
      APP_ENV: ${APP_ENV:-prod}
      APP_SECRET: ${APP_SECRET}
      DATABASE_URL: ${DATABASE_URL}
      
      # JWT
      JWT_SECRET_KEY: ${JWT_SECRET_KEY}
      JWT_PUBLIC_KEY: ${JWT_PUBLIC_KEY}
      JWT_PASSPHRASE: ${JWT_PASSPHRASE}
      
      # Elasticsearch
      ELASTICSEARCH_HOST: ${ELASTICSEARCH_HOST:-http://elasticsearch:9200}
      
      # CORS
      CORS_ALLOW_ORIGIN: ${CORS_ALLOW_ORIGIN}
      
      # Autres
      TRUSTED_PROXIES: ${TRUSTED_PROXIES:-127.0.0.1,REMOTE_ADDR}
      TRUSTED_HOSTS: ${TRUSTED_HOSTS:-localhost,127.0.0.1}
    
    # Labels Traefik pour le routage et HTTPS
    labels:
      - "traefik.enable=true"
      
      # HTTP Router
      - "traefik.http.routers.joy-pharma-backend.rule=Host(`${API_DOMAIN:-api.joypharma.com}`)"
      - "traefik.http.routers.joy-pharma-backend.entrypoints=websecure"
      - "traefik.http.routers.joy-pharma-backend.tls=true"
      - "traefik.http.routers.joy-pharma-backend.tls.certresolver=letsencrypt"
      
      # Service
      - "traefik.http.services.joy-pharma-backend.loadbalancer.server.port=80"
      
      # Middleware pour CORS (si nécessaire)
      - "traefik.http.middlewares.joy-pharma-backend-cors.headers.accesscontrolallowmethods=GET,POST,PUT,DELETE,PATCH,OPTIONS"
      - "traefik.http.middlewares.joy-pharma-backend-cors.headers.accesscontrolalloworigin=*"
      - "traefik.http.middlewares.joy-pharma-backend-cors.headers.accesscontrolmaxage=100"
      - "traefik.http.middlewares.joy-pharma-backend-cors.headers.addvaryheader=true"
      
      # Health check (optionnel)
      - "traefik.http.services.joy-pharma-backend.loadbalancer.healthcheck.path=/api/health"
      - "traefik.http.services.joy-pharma-backend.loadbalancer.healthcheck.interval=30s"
    
    # Politique de redémarrage
    restart: unless-stopped
    
    # Healthcheck
    healthcheck:
      test: ["CMD", "php", "-v"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

# Réseaux externes (déjà créés par Traefik et Infrastructure)
networks:
  traefik-network:
    external: true
  infrastructure_default:
    external: true

