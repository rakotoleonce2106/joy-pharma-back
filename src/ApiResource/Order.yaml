App\Entity\Order:
    operations:
        post_order:
            class: ApiPlatform\Metadata\Post
            uriTemplate: "/order"
            input: App\Dto\OrderInput
            processor: App\State\Order\OrderCreateProcessor
            format: 'json'
            normalizationContext:
                groups: ['id:read','order:read','location:read','user:read','product:read','image:read']
            openapi:
                summary: 'Create a order'
                description: 'Create a order'

        get_current_order:
            method: 'GET'
            class: ApiPlatform\Metadata\Get
            uriTemplate: '/order/current'
            security: 'is_granted("ROLE_DELIVER")'
            provider: App\State\Order\CurrentOrderProvider
            normalizationContext:
                groups: ['id:read','order:read','image:read','product:read', 'location:read', 'user:read','store:read']
            openapi:
                summary: 'Get current active order'
                description: 'Get the current order being delivered by the authenticated delivery person (ROLE_DELIVER required)'

                
        get_order:
            method: 'GET'
            class: ApiPlatform\Metadata\Get
            uriTemplate: '/order/{id}'
            normalizationContext:
                groups: ['id:read','order:read','location:read','user:read','product:read','image:read','store:read']
            openapi:
                summary: 'Get a order'
                description: 'Get a order by id'
                parameters:
                    - name: 'id'
                      in: 'path'
                      description:  'The id of the order'

        get_orders:
            method: 'GET'
            class: ApiPlatform\Metadata\GetCollection
            uriTemplate: '/orders'
            normalizationContext:
                groups: ['id:read','order:read','location:read','user:read','product:read','image:read','store:read']
            openapi:
                summary: 'Get all orders'
                description: 'Get all orders'
                security:
                    -   JWT: [ 'ROLE_ADMIN','ROLE_USER','ROLE_STORE','ROLE_DELIVER' ]

        # Available orders for delivery (no pagination)
        get_available_orders:
            method: 'GET'
            class: ApiPlatform\Metadata\GetCollection
            uriTemplate: '/orders/available'
            security: 'is_granted("ROLE_DELIVER")'
            provider: App\State\Order\AvailableOrdersProvider
            paginationEnabled: false
            normalizationContext:
                groups: ['id:read','order:read','location:read','user:read','product:read','image:read','store:read']
            openapi:
                summary: 'Get available orders for delivery'
                description: 'List all orders with status pending and no assigned deliver (no pagination)'

        store_update_order:
            class: ApiPlatform\Metadata\Put
            uriTemplate: '/store/order/{id}'
            input: App\Dto\StoreUpdateOrderInput
            processor: App\State\Store\StoreUpdateOrderProcessor
            format: 'json'
            security: 'is_granted("ROLE_STORE")'
            normalizationContext:
                groups: ['id:read','order:read','location:read','user:read','product:read','image:read']
            openapi:
                summary: 'Store updates order with order item actions'
                description: 'Store owner updates an order by accepting, refusing, or suggesting alternatives for multiple order items in one request'
                security:
                    - JWT: ['ROLE_STORE']
                parameters:
                    - name: id
                      in: path
                      required: true
                      description: 'The ID of the order to update'
                      schema:
                          type: integer

        # Get order history
        get_order_history:
            class: ApiPlatform\Metadata\GetCollection
            uriTemplate: '/orders/history'
            security: 'is_granted("ROLE_USER")'
            provider: App\State\Order\OrderHistoryProvider
            normalizationContext:
                groups: ['order:read', 'location:read', 'user:read']
            openapi:
                summary: 'Get order history'
                description: 'Get delivery history for current user'
                parameters:
                    - name: page
                      in: query
                      schema:
                          type: integer
                          default: 1
                    - name: limit
                      in: query
                      schema:
                          type: integer
                          default: 20
                    - name: status
                      in: query
                      schema:
                          type: string

        # Accept order
        accept_order:
            class: ApiPlatform\Metadata\Post
            uriTemplate: '/orders/{id}/accept'
            security: 'is_granted("ROLE_USER")'
            processor: App\State\Order\AcceptOrderProcessor
            input: false
            normalizationContext:
                groups: ['order:read', 'location:read', 'user:read']
            openapi:
                summary: 'Accept order for delivery'
                description: 'Accept an available order and assign it to current delivery person'

        # Reject order
        reject_order:
            class: ApiPlatform\Metadata\Post
            uriTemplate: '/orders/{id}/reject'
            security: 'is_granted("ROLE_USER")'
            processor: App\State\Order\RejectOrderProcessor
            input: false
            openapi:
                summary: 'Reject order'
                description: 'Reject an order (removes from available list)'

        # Update order status
        update_order_status:
            class: ApiPlatform\Metadata\Put
            uriTemplate: '/orders/{id}/status'
            security: 'is_granted("ROLE_USER")'
            processor: App\State\Order\UpdateOrderStatusProcessor
            input: App\Dto\UpdateOrderStatusInput
            normalizationContext:
                groups: ['order:read', 'location:read', 'user:read']
            openapi:
                summary: 'Update order status'
                description: 'Update delivery order status (processing, shipped, delivered, etc.)'

        # Validate QR code for delivery
        validate_qr:
            class: ApiPlatform\Metadata\Post
            uriTemplate: '/orders/{id}/validate-qr'
            security: 'is_granted("ROLE_DELIVER")'
            processor: App\State\Order\ValidateQRProcessor
            input: App\Dto\ValidateQRInput
            normalizationContext:
                groups: ['order:read', 'location:read', 'user:read']
            openapi:
                summary: 'Validate QR code for delivery'
                description: 'Scan and validate customer QR code to confirm order delivery. Verifies QR code matches the order, logs the scan attempt, and marks order as delivered if valid. Returns error message in French if QR code is invalid.'
                parameters:
                    - name: id
                      in: path
                      required: true
                      description: 'The ID of the order to deliver'
                      schema:
                          type: integer

        # Scan order QR code for pickup
        scan_store_qr:
            class: ApiPlatform\Metadata\Post
            uriTemplate: '/orders/{id}/scan-store-qr'
            security: 'is_granted("ROLE_DELIVER")'
            processor: App\State\Order\StoreQRScanProcessor
            input: App\Dto\StoreQRScanInput
            normalizationContext:
                groups: ['order:read', 'location:read', 'user:read', 'store:read']
            openapi:
                summary: 'Scan order QR code for pickup verification'
                description: 'Scan the order QR code displayed at the store to verify order collection (récupération). Verifies that the QR code matches the order, updates all OrderItemStatus to RECUPERATED for accepted items, and marks the order as collected if all items are recuperated. The QR code is generated by the store and linked to the specific order.'
                parameters:
                    - name: id
                      in: path
                      required: true
                      description: 'The ID of the order to collect'
                      schema:
                          type: integer

        # Submit rating
        submit_rating:
            class: ApiPlatform\Metadata\Post
            uriTemplate: '/orders/{id}/rating'
            security: 'is_granted("ROLE_USER")'
            processor: App\State\Order\RatingProcessor
            input: App\Dto\RatingInput
            openapi:
                summary: 'Submit order rating'
                description: 'Submit rating for delivered order'

        # Report issue
        report_issue:
            class: ApiPlatform\Metadata\Post
            uriTemplate: '/orders/{id}/report-issue'
            security: 'is_granted("ROLE_USER")'
            processor: App\State\Order\ReportIssueProcessor
            input: App\Dto\ReportIssueInput
            openapi:
                summary: 'Report order issue'
                description: 'Report an issue with an order'

    normalizationContext:
        groups: ['id:read','order:read']

