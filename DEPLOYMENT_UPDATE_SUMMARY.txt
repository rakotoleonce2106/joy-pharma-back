â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                                      â•‘
â•‘   âœ…  WORKFLOWS GITHUB ACTIONS MIS Ã€ JOUR POUR DOCKER + INFISICAL  â•‘
â•‘                                                                      â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“¦ FICHIERS MODIFIÃ‰S
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ¤– Workflows GitHub Actions (3 fichiers modifiÃ©s)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âœ… .github/workflows/deploy-build.yml     - Build avec FrankenPHP
âœ… .github/workflows/deploy-server.yml    - DÃ©ploiement avec Infisical
âœ… .github/workflows/deploy-env.yml       - Copie fichiers config

ğŸ“– Documentation (2 fichiers crÃ©Ã©s)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âœ… docs/infisical.md                      - Guide Infisical complet
âœ… DEPLOYMENT.md                          - Guide dÃ©ploiement complet

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ”„ CHANGEMENTS PRINCIPAUX
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. deploy-build.yml
   âœ… Target changÃ© vers : frankenphp_prod
   âœ… Build argument : PHP_VERSION=8.3
   âœ… Platform : linux/amd64 (optimisÃ©)
   âœ… Cache GitHub Actions maintenu

2. deploy-env.yml
   âœ… Copie de compose.prod.yaml
   âœ… Copie du dossier frankenphp/
   âœ… Structure complÃ¨te pour FrankenPHP

3. deploy-server.yml (changements majeurs)
   âœ… Utilise compose.yaml + compose.prod.yaml
   âœ… Export Infisical en format dotenv
   âœ… Ajout variables Docker (IMAGES_PREFIX, etc.)
   âœ… Pull multi-services (php, database, elasticsearch)
   âœ… DÃ©marrage avec compose.prod.yaml
   âœ… VÃ©rification santÃ© de tous les services
   âœ… Attente que PostgreSQL soit prÃªt
   âœ… ExÃ©cution automatique des migrations
   âœ… Clear et warmup du cache Symfony
   âœ… Health checks amÃ©liorÃ©s
   âœ… Rollback automatique si Ã©chec

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ” CONFIGURATION INFISICAL REQUISE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Secrets GitHub Ã  Configurer:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
INFISICAL_CLIENT_ID       â†’ Client ID de la Machine Identity
INFISICAL_CLIENT_SECRET    â†’ Client Secret de la Machine Identity
INFISICAL_PROJECTID        â†’ ID du projet Infisical
INFISICAL_DOMAIN          â†’ https://app.infisical.com (ou votre instance)

SSH_HOST                  â†’ Adresse du serveur
SSH_USER                  â†’ Utilisateur SSH
SSH_PRIVATE_KEY           â†’ ClÃ© SSH privÃ©e
SSH_PORT                  â†’ Port SSH (dÃ©faut: 22)

DOCKERHUB_USERNAME        â†’ Nom d'utilisateur Docker Hub
DOCKERHUB_TOKEN           â†’ Token d'accÃ¨s Docker Hub

SERVER_NAME               â†’ Nom de domaine (ex: api.example.com)

Variables dans Infisical (environnement prod):
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
APP_ENV=prod
APP_SECRET=votre_secret_unique
APP_DEBUG=0

DATABASE_URL=postgresql://app:password@database:5432/app?serverVersion=16&charset=utf8
POSTGRES_PASSWORD=mot_de_passe_securise

JWT_PASSPHRASE=votre_passphrase_jwt

SERVER_NAME=api.votre-domaine.com
CADDY_MERCURE_JWT_SECRET=secret_mercure_unique

CORS_ALLOW_ORIGIN='^https?://(www\.)?votre-domaine\.com$'

ELASTICSEARCH_URL=http://elasticsearch:9200

MAILER_DSN=smtp://user:pass@smtp.example.com:587

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸš€ PROCESSUS DE DÃ‰PLOIEMENT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Automatique:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. Push vers branche "preprod"
2. GitHub Actions dÃ©clenche automatiquement le workflow
3. Build de l'image Docker (target: frankenphp_prod)
4. Push vers Docker Hub
5. Copie des fichiers de config sur le serveur
6. Installation/VÃ©rification Infisical CLI
7. Connexion Ã  Infisical et export des secrets
8. Pull de la nouvelle image
9. DÃ©marrage des conteneurs (php, database, elasticsearch)
10. Attente que PostgreSQL soit prÃªt
11. ExÃ©cution des migrations Doctrine
12. Clear + warmup du cache Symfony
13. VÃ©rification de la santÃ© des services
14. Nettoyage des anciennes images
15. DÃ©ploiement terminÃ© âœ…

Manuel via GitHub:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. Aller sur GitHub â†’ Actions
2. SÃ©lectionner "Deploy to Production"
3. Cliquer "Run workflow"
4. SÃ©lectionner la branche
5. Cliquer "Run workflow"

Manuel via SSH:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ssh deploy@serveur.com
cd ~/joypharma
infisical login --method=universal-auth ...
infisical export --env=prod --format=dotenv > .env
echo "IMAGES_PREFIX=user/" >> .env
docker compose -f compose.yaml -f compose.prod.yaml pull
docker compose -f compose.yaml -f compose.prod.yaml up -d
docker compose -f compose.yaml -f compose.prod.yaml exec php \
  bin/console doctrine:migrations:migrate --no-interaction

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ¨ NOUVELLES FONCTIONNALITÃ‰S
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ… Support FrankenPHP avec Mode Worker
   â†’ Performances 15x supÃ©rieures en production
   â†’ HTTP/2 et HTTP/3 natifs
   â†’ HTTPS automatique avec Let's Encrypt

âœ… Multi-services
   â†’ PostgreSQL 16 (base de donnÃ©es)
   â†’ Elasticsearch 8.11 (recherche)
   â†’ Healthchecks pour tous les services

âœ… Gestion des Secrets avec Infisical
   â†’ Centralisation sÃ©curisÃ©e
   â†’ Synchronisation automatique
   â†’ Audit et traÃ§abilitÃ©
   â†’ Rotation facilitÃ©e

âœ… Migrations Automatiques
   â†’ ExÃ©cution automatique lors du dÃ©ploiement
   â†’ Rollback si Ã©chec

âœ… Health Checks AmÃ©liorÃ©s
   â†’ VÃ©rification de tous les services
   â†’ DÃ©tection des restart loops
   â†’ Rollback automatique si problÃ¨me

âœ… Cache OptimisÃ©
   â†’ Clear automatique du cache
   â†’ Warmup pour performances

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“‹ CHECKLIST POST-DÃ‰PLOIEMENT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Configuration Infisical:
â˜ Projet crÃ©Ã© dans Infisical
â˜ Tous les secrets ajoutÃ©s dans l'environnement "prod"
â˜ Machine Identity crÃ©Ã©e avec Universal Auth
â˜ Permissions Read/Write configurÃ©es

Configuration GitHub:
â˜ Tous les secrets GitHub configurÃ©s
â˜ ClÃ© SSH ajoutÃ©e et testÃ©e
â˜ Token Docker Hub valide
â˜ Variables d'environnement dÃ©finies

Sur le Serveur:
â˜ Docker et Docker Compose installÃ©s
â˜ RÃ©pertoire ~/joypharma crÃ©Ã©
â˜ Firewall configurÃ© (ports 22, 80, 443)
â˜ Domaine pointant vers le serveur

Premier DÃ©ploiement:
â˜ Push vers preprod effectuÃ©
â˜ Workflow GitHub Actions rÃ©ussi
â˜ Services dÃ©marrÃ©s (docker compose ps)
â˜ Migrations exÃ©cutÃ©es
â˜ Application accessible via HTTPS
â˜ Certificat SSL valide
â˜ API fonctionnelle (/api, /docs)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ” VÃ‰RIFICATIONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

AprÃ¨s DÃ©ploiement:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# VÃ©rifier les services
docker compose -f compose.yaml -f compose.prod.yaml ps

# RÃ©sultat attendu :
NAME           STATUS         PORTS
php            Up (healthy)   80/tcp, 443/tcp
database       Up (healthy)   5432/tcp
elasticsearch  Up (healthy)   9200/tcp

# VÃ©rifier les logs
docker compose -f compose.yaml -f compose.prod.yaml logs

# Tester l'application
curl https://api.votre-domaine.com
curl https://api.votre-domaine.com/api
curl https://api.votre-domaine.com/docs

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“š DOCUMENTATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Guides Disponibles:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ“– DEPLOYMENT.md              â†’ Guide complet de dÃ©ploiement
ğŸ” docs/infisical.md          â†’ Configuration Infisical dÃ©taillÃ©e
ğŸš¢ docs/production.md         â†’ Guide production
ğŸ³ DOCKER.md                  â†’ Documentation Docker
ğŸ“¥ INSTALLATION.md            â†’ Installation locale

Workflows:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
.github/workflows/deploy.yml          â†’ Workflow principal
.github/workflows/deploy-build.yml    â†’ Build Docker
.github/workflows/deploy-server.yml   â†’ DÃ©ploiement serveur
.github/workflows/deploy-env.yml      â†’ PrÃ©paration environnement
.github/workflows/docker.yml          â†’ CI Docker (tests)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ†˜ TROUBLESHOOTING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Erreur : "Failed to generate Infisical token"
â†’ VÃ©rifier CLIENT_ID et CLIENT_SECRET dans GitHub Secrets
â†’ VÃ©rifier les permissions de la Machine Identity

Erreur : ".env file is empty"
â†’ VÃ©rifier que les secrets sont dÃ©finis dans Infisical
â†’ VÃ©rifier l'environnement cible (prod)

Erreur : "Container keeps restarting"
â†’ VÃ©rifier les logs : docker compose logs php
â†’ VÃ©rifier DATABASE_URL dans Infisical
â†’ VÃ©rifier que tous les secrets requis sont dÃ©finis

Erreur : "Database connection failed"
â†’ VÃ©rifier que PostgreSQL est dÃ©marrÃ©
â†’ VÃ©rifier DATABASE_URL (host = "database" pas "localhost")
â†’ Format : postgresql://user:pass@database:5432/dbname

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ‰ AVANTAGES DE CETTE CONFIGURATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ¨ SÃ©curitÃ©
   â†’ Secrets jamais en clair
   â†’ Rotation facilitÃ©e
   â†’ Audit complet

âœ¨ Performance
   â†’ FrankenPHP Mode Worker
   â†’ HTTP/3 natif
   â†’ Cache optimisÃ©

âœ¨ FiabilitÃ©
   â†’ Healthchecks automatiques
   â†’ Rollback automatique
   â†’ Migrations automatiques

âœ¨ MaintenabilitÃ©
   â†’ Documentation complÃ¨te
   â†’ Workflows standardisÃ©s
   â†’ Logs structurÃ©s

âœ¨ DevOps
   â†’ CI/CD automatique
   â†’ DÃ©ploiement en 1 push
   â†’ Monitoring intÃ©grÃ©

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“ SUPPORT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Documentation : Consultez les guides dans docs/
Issues GitHub : Ouvrez une issue pour tout problÃ¨me
Email : support@joypharma.com

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

            âœ…  Workflows mis Ã  jour avec succÃ¨s !  âœ…

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
