services:
  php:
    image: ${DOCKERHUB_USERNAME:-joyleonce}/joy-pharma-back:${TAG:-latest}
    container_name: joy-pharma-back-php
    restart: always
    expose:
      - "80"
    
    # üìÅ VOLUMES - Images et uploads persistants
    # Stock√©s dans ./data/ (dossier du projet, ignor√© par Git)
    volumes:
      - ./data/images:/app/public/images:rw
      - ./data/media:/app/public/media:rw
      - ./data/uploads:/app/public/uploads:rw
    
    labels:
      - traefik.enable=true
      - traefik.http.routers.joy-back.rule=Host(`${SERVER_NAME:-preprod.joy-pharma.com}`)
      - traefik.http.routers.joy-back.entrypoints=websecure
      - traefik.http.routers.joy-back.tls=true
      - traefik.http.routers.joy-back.tls.certresolver=letsencrypt
      - traefik.http.services.joy-back.loadbalancer.server.port=80
    environment:
      SERVER_NAME: ${SERVER_NAME:-preprod.joy-pharma.com}
      DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@shared-postgres:5432/${POSTGRES_DB}?serverVersion=16&charset=utf8
      APP_ENV: ${APP_ENV:-prod}
      APP_SECRET: ${APP_SECRET}
      JWT_PASSPHRASE: ${JWT_PASSPHRASE}
      # Configuration m√©moire pour FrankenPHP
      GOMEMLIMIT: 12000000000
      PHP_MEMORY_LIMIT: 512M
    deploy:
      resources:
        limits:
          memory: 12G
        reservations:
          memory: 2G
    networks:
      - traefik_network
      - database_network

networks:
  traefik_network:
    external: true
  database_network:
    external: true
