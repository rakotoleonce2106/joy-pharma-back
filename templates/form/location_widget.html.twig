{% block _location_widget %}
<div class="space-y-4" data-controller="location-map" data-action="turbo:load->location-map#refresh">
    {# Header #}
    <div class="flex items-center gap-2">
        <twig:ux:icon name="lucide:map-pin" class="h-5 w-5 text-green-600"/>
        <div>
            <h4 class="text-base font-semibold">{{ label|default('Location') }}</h4>
            {% if required is same as false %}
                <p class="text-sm text-muted-foreground">(Optional - leave empty for pickup orders)</p>
            {% endif %}
        </div>
    </div>

    {# Map Container #}
    <div class="rounded-lg overflow-hidden border border-gray-200 dark:border-gray-700 shadow-sm bg-white dark:bg-gray-900">
        <div 
            data-location-map-target="map" 
            id="location-map-{{ form.vars.id|default(random()) }}"
            class="w-full location-map-container"
            style="height: 400px !important; min-height: 400px !important; width: 100% !important; position: relative; z-index: 1; display: block !important;"
        >
            <div class="flex items-center justify-center h-full text-muted-foreground" data-location-map-loading="true">
                <div class="text-center">
                    <twig:ux:icon name="lucide:map-pin" class="h-12 w-12 mx-auto mb-2 opacity-50"/>
                    <p class="text-sm">Loading map...</p>
                </div>
            </div>
        </div>
    </div>

    {# Address Input Section #}
    <div class="space-y-2">
        <label class="block text-sm font-medium mb-1">{{ 'Address'|trans }}</label>
        {{ form_widget(form.address, {
            'attr': {
                'data-location-map-target': 'address',
                'class': 'w-full rounded-md border border-input bg-background px-3 py-2 text-sm',
                'placeholder': 'Click on map to select location or enter address manually'
            }
        }) }}
        {{ form_errors(form.address) }}
        <p class="text-xs text-muted-foreground">
            {{ 'Click on the map to select a location, or enter an address and press Enter to search'|trans }}
        </p>
    </div>

    {# Coordinate Input Section #}
    <div class="grid grid-cols-2 gap-4">
        <div class="space-y-2">
            <label class="block text-sm font-medium mb-1">{{ 'Latitude'|trans }}</label>
            {{ form_widget(form.latitude, {
                'attr': {
                    'data-location-map-target': 'latitude',
                    'class': 'w-full rounded-md border border-input bg-background px-3 py-2 text-sm bg-muted/30',
                    'type': 'number',
                    'step': '0.000001',
                    'readonly': true
                }
            }) }}
            {{ form_errors(form.latitude) }}
            <p class="text-xs text-muted-foreground">{{ 'Auto-filled from map'|trans }}</p>
        </div>
        <div class="space-y-2">
            <label class="block text-sm font-medium mb-1">{{ 'Longitude'|trans }}</label>
            {{ form_widget(form.longitude, {
                'attr': {
                    'data-location-map-target': 'longitude',
                    'class': 'w-full rounded-md border border-input bg-background px-3 py-2 text-sm bg-muted/30',
                    'type': 'number',
                    'step': '0.000001',
                    'readonly': true
                }
            }) }}
            {{ form_errors(form.longitude) }}
            <p class="text-xs text-muted-foreground">{{ 'Auto-filled from map'|trans }}</p>
        </div>
    </div>

    {# How to use Instructions #}
    <div class="flex items-start gap-2 p-3 bg-blue-50 dark:bg-blue-950/20 border border-blue-200 dark:border-blue-800 rounded-lg text-sm">
        <twig:ux:icon name="lucide:info" class="h-5 w-5 text-blue-600 dark:text-blue-400 flex-shrink-0 mt-0.5"/>
        <div class="text-blue-900 dark:text-blue-100 space-y-1">
            <p class="font-medium">{{ 'How to use:'|trans }}</p>
            <ul class="list-disc list-inside space-y-0.5 text-blue-700 dark:text-blue-300">
                <li>{{ 'Click anywhere on the map to set the delivery location'|trans }}</li>
                <li>{{ 'Drag the marker to adjust the position'|trans }}</li>
                <li>{{ 'Or enter an address in the field above to search'|trans }}</li>
                {% if required is same as false %}
                    <li>{{ 'Leave empty for pickup orders'|trans }}</li>
                {% endif %}
            </ul>
        </div>
    </div>
</div>
{% endblock %}

{% block _store_location_widget %}
    {{ block('_location_widget') }}
{% endblock %}

{% block _order_location_widget %}
<div class="space-y-4" data-controller="location-map">
    {# Map Container - Show first #}
    <div class="relative">
        <div class="flex items-center gap-2 mb-3 px-4 py-2.5 bg-blue-50 dark:bg-blue-950/20 border border-blue-200 dark:border-blue-800 rounded-lg">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-600 dark:text-blue-400 flex-shrink-0">
                <circle cx="12" cy="12" r="10"/>
                <path d="M12 16v-4"/>
                <path d="M12 8h.01"/>
            </svg>
            <div class="text-sm text-blue-900 dark:text-blue-100">
                <strong class="font-semibold">Interactive Map:</strong> 
                Click on the map to set delivery location, drag the marker to adjust, or search for an address.
            </div>
        </div>
        
        <div class="rounded-lg overflow-hidden border border-gray-200 dark:border-gray-700 shadow-sm">
            <div 
                data-location-map-target="map" 
                id="location-map-{{ form.vars.id|default(random()) }}"
                class="w-full location-map-container rounded-lg border-2 border-border shadow-lg"
                style="height: 450px !important; min-height: 450px !important; width: 100% !important; position: relative; z-index: 1; display: block !important;"
            >
                <div class="flex items-center justify-center h-full text-muted-foreground" data-location-map-loading="true">
                    <div class="text-center">
                        <twig:ux:icon name="lucide:map-pin" class="h-12 w-12 mx-auto mb-2 opacity-50"/>
                        <p class="text-sm">Loading map...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="absolute bottom-4 left-4 bg-white dark:bg-gray-800 px-3 py-2 rounded-lg shadow-lg border border-border z-[1000]">
            <div class="text-xs font-medium text-muted-foreground uppercase mb-1">Map Controls</div>
            <div class="text-xs text-muted-foreground space-y-1">
                <div>üñ±Ô∏è Click to place marker</div>
                <div>üîç Search for location</div>
                <div>üìç Drag marker to adjust</div>
            </div>
        </div>
    </div>

    {# Form Fields #}
    <div class="grid gap-4 md:grid-cols-3">
        <div class="md:col-span-2">
            {{ form_widget(form.address, {
                'attr': {
                    'data-location-map-target': 'address',
                    'class': 'w-full rounded-md border border-input bg-background px-3 py-2 text-sm',
                    'placeholder': 'Enter delivery address or search on map...'
                }
            }) }}
            {{ form_label(form.address, 'Delivery Address') }}
            {{ form_errors(form.address) }}
            <p class="text-xs text-muted-foreground mt-1">
                Click on the map to select a location, or enter an address and press Enter to search
            </p>
        </div>
        <div class="grid grid-cols-2 gap-2">
            {{ form_widget(form.latitude, {
                'attr': {
                    'data-location-map-target': 'latitude',
                    'readonly': true,
                    'class': 'bg-muted/30 w-full rounded-md border border-input bg-background px-3 py-2 text-sm'
                }
            }) }}
            {{ form_label(form.latitude, 'Latitude') }}
            {{ form_errors(form.latitude) }}
            {{ form_widget(form.longitude, {
                'attr': {
                    'data-location-map-target': 'longitude',
                    'readonly': true,
                    'class': 'bg-muted/30 w-full rounded-md border border-input bg-background px-3 py-2 text-sm'
                }
            }) }}
            {{ form_label(form.longitude, 'Longitude') }}
            {{ form_errors(form.longitude) }}
        </div>
    </div>
</div>
{% endblock %}
