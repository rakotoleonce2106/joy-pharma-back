{% extends 'admin/layout.html.twig' %}

{% block title %}{{ 'Order Details'|trans }}{% endblock %}

{% block content %}
    <main class="flex flex-1 flex-col gap-4 p-4 md:gap-8 md:p-8 w-[85rem]">
        <div class="mx-auto grid w-full max-w-6xl gap-6">
            <div class="flex items-center gap-4">
                <twig:ui:button:root href="{{ path('admin_order') }}" variant="outline" size="icon" class="h-8 w-8">
                    <twig:ux:icon name="radix-icons:chevron-left" class="h-4 w-4"/>
                    <span class="sr-only">{{ 'Back'|trans }}</span>
                </twig:ui:button:root>
                <h1 class="flex-1 text-3xl font-bold tracking-tight">
                    {{ 'Order'|trans }} #{{ order.reference }}
                </h1>
                <div class="hidden items-center gap-2 md:flex">
                    <twig:ui:button:root variant="outline" size="sm" href="{{ path('admin_order_edit', {id: order.id}) }}">
                        <twig:ux:icon name="lucide:edit" class="h-4 w-4 mr-2"/>
                        {{ 'Edit'|trans }}
                    </twig:ui:button:root>
                </div>
            </div>

            {# Order Status Summary with All Stores #}
            {% set unique_stores = [] %}
            {% set unique_store_ids = [] %}
            {% for item in order.items %}
                {% if item.store and item.store.id not in unique_store_ids %}
                    {% set unique_stores = unique_stores|merge([item.store]) %}
                    {% set unique_store_ids = unique_store_ids|merge([item.store.id]) %}
                {% endif %}
            {% endfor %}

            {# Stores Overview Card #}
            {% if unique_stores|length > 0 %}
                <twig:ui:card:root>
                    <twig:ui:card:header>
                        <twig:ui:card:title>{{ 'Order Status by Store'|trans }}</twig:ui:card:title>
                        <twig:ui:card:description>
                            {{ 'Status overview for all stores in this order'|trans }}
                        </twig:ui:card:description>
                    </twig:ui:card:header>
                    <twig:ui:card:content>
                        <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
                            {% for store in unique_stores %}
                                {% set accepted_count = order.items|filter(item => item.store and item.store.id == store.id and item.storeStatus.value == 'accepted')|length %}
                                {% set refused_count = order.items|filter(item => item.store and item.store.id == store.id and item.storeStatus.value == 'refused')|length %}
                                {% set suggested_count = order.items|filter(item => item.store and item.store.id == store.id and item.storeStatus.value == 'suggested')|length %}
                                {% set pending_count = order.items|filter(item => item.store and item.store.id == store.id and item.storeStatus.value == 'pending')|length %}
                                {% set approved_count = order.items|filter(item => item.store and item.store.id == store.id and item.storeStatus.value == 'approved')|length %}
                                {% set rejected_count = order.items|filter(item => item.store and item.store.id == store.id and item.storeStatus.value == 'rejected')|length %}
                                
                                {% set overall_status = accepted_count > 0 and refused_count == 0 and suggested_count == 0 ? 'accepted' : (refused_count > 0 ? 'refused' : (suggested_count > 0 ? 'suggested' : 'pending')) %}
                                {% set storeOverallClass = overall_status == 'accepted' ? 'bg-green-100 text-green-800 dark:bg-green-900/20 dark:text-green-400' : (overall_status == 'refused' ? 'bg-red-100 text-red-800 dark:bg-red-900/20 dark:text-red-400' : (overall_status == 'suggested' ? 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/20 dark:text-yellow-400' : 'bg-gray-100 text-gray-800 dark:bg-gray-900/20 dark:text-gray-400')) %}
                                
                                <div class="p-4 border rounded-lg bg-card">
                                    <div class="flex items-center justify-between mb-3">
                                        <h4 class="font-semibold text-sm">{{ store.name }}</h4>
                                        <span class="inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium {{ storeOverallClass }}">
                                            {{ overall_status|capitalize }}
                                        </span>
                                    </div>
                                    <div class="space-y-2 text-xs">
                                        {% if accepted_count > 0 %}
                                            <div class="flex items-center justify-between">
                                                <span class="text-muted-foreground">{{ 'Accepted'|trans }}:</span>
                                                <span class="font-medium text-green-600">{{ accepted_count }}</span>
                                            </div>
                                        {% endif %}
                                        {% if refused_count > 0 %}
                                            <div class="flex items-center justify-between">
                                                <span class="text-muted-foreground">{{ 'Refused'|trans }}:</span>
                                                <span class="font-medium text-red-600">{{ refused_count }}</span>
                                            </div>
                                        {% endif %}
                                        {% if suggested_count > 0 %}
                                            <div class="flex items-center justify-between">
                                                <span class="text-muted-foreground">{{ 'Suggested'|trans }}:</span>
                                                <span class="font-medium text-yellow-600">{{ suggested_count }}</span>
                                            </div>
                                        {% endif %}
                                        {% if pending_count > 0 %}
                                            <div class="flex items-center justify-between">
                                                <span class="text-muted-foreground">{{ 'Pending'|trans }}:</span>
                                                <span class="font-medium text-gray-600">{{ pending_count }}</span>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </twig:ui:card:content>
                </twig:ui:card:root>
            {% endif %}

            <div class="grid gap-6 lg:grid-cols-3">
                {# Order Details Card #}
                <twig:ui:card:root class="lg:col-span-2">
                    <twig:ui:card:header>
                        <twig:ui:card:title>{{ 'Order Details'|trans }}</twig:ui:card:title>
                        <twig:ui:card:description>
                            {{ 'Created on'|trans }} {{ order.createdAt|date('F d, Y \a\t H:i') }}
                        </twig:ui:card:description>
                    </twig:ui:card:header>
                    <twig:ui:card:content class="grid gap-6">
                        {# Status and Priority #}
                        <div class="grid gap-3">
                            <div class="flex items-center justify-between">
                                <span class="text-sm font-medium">{{ 'Status'|trans }}</span>
                                {% set statusClass = order.status.value == 'delivered' ? 'bg-green-100 text-green-800' : (order.status.value == 'cancelled' ? 'bg-red-100 text-red-800' : (order.status.value == 'pending' ? 'bg-yellow-100 text-yellow-800' : 'bg-blue-100 text-blue-800')) %}
                                <span class="inline-flex items-center rounded-full px-3 py-1 text-sm font-medium {{ statusClass }}">
                                    {{ order.status.value|capitalize }}
                                </span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-sm font-medium">{{ 'Priority'|trans }}</span>
                                {% set priorityClass = order.priority.value == 'urgent' ? 'bg-red-100 text-red-800' : (order.priority.value == 'planified' ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-800') %}
                                <span class="inline-flex items-center rounded-full px-3 py-1 text-sm font-medium {{ priorityClass }}">
                                    {{ order.priority.value|capitalize }}
                                </span>
                            </div>
                        </div>

                        {# Customer Information #}
                        {% if order.owner %}
                            <div class="border-t pt-4">
                                <h3 class="font-semibold mb-3">{{ 'Customer Information'|trans }}</h3>
                                <div class="grid gap-2 text-sm">
                                    <div class="flex items-center justify-between">
                                        <span class="text-muted-foreground">{{ 'Name'|trans }}</span>
                                        <span class="font-medium">{{ order.owner.fullName }}</span>
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <span class="text-muted-foreground">{{ 'Email'|trans }}</span>
                                        <span class="font-medium">{{ order.owner.email }}</span>
                                    </div>
                                    {% if order.phone %}
                                        <div class="flex items-center justify-between">
                                            <span class="text-muted-foreground">{{ 'Phone'|trans }}</span>
                                            <span class="font-medium">{{ order.phone }}</span>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        {% endif %}

                        {# Delivery Information - Enhanced #}
                        <div class="border-t pt-4">
                            <div class="flex items-center justify-between mb-3">
                                <h3 class="font-semibold">{{ 'Delivery Information'|trans }}</h3>
                                {% if order.deliver %}
                                    <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900/20 dark:text-green-400">
                                        <twig:ux:icon name="lucide:truck" class="h-3 w-3 mr-1"/>
                                        {{ 'Assigned'|trans }}
                                    </span>
                                {% else %}
                                    <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium bg-yellow-100 text-yellow-800 dark:bg-yellow-900/20 dark:text-yellow-400">
                                        <twig:ux:icon name="lucide:alert-circle" class="h-3 w-3 mr-1"/>
                                        {{ 'Not Assigned'|trans }}
                                    </span>
                                {% endif %}
                            </div>
                            <div class="grid gap-3 text-sm">
                                {% if order.deliver %}
                                    <div class="p-3 bg-green-50 dark:bg-green-900/10 rounded-lg border border-green-200 dark:border-green-800">
                                        <div class="flex items-center justify-between">
                                            <span class="text-muted-foreground flex items-center gap-2">
                                                <twig:ux:icon name="lucide:user" class="h-4 w-4"/>
                                                {{ 'Delivery Person'|trans }}
                                            </span>
                                            <span class="font-medium">{{ order.deliver.fullName }}</span>
                                        </div>
                                        {% if order.deliver.email %}
                                            <div class="mt-2 flex items-center justify-between text-xs text-muted-foreground">
                                                <span>{{ 'Email'|trans }}</span>
                                                <span>{{ order.deliver.email }}</span>
                                            </div>
                                        {% endif %}
                                    </div>
                                {% else %}
                                    <div class="p-3 bg-yellow-50 dark:bg-yellow-900/10 rounded-lg border border-yellow-200 dark:border-yellow-800">
                                        <div class="flex items-center justify-between">
                                            <span class="text-muted-foreground flex items-center gap-2">
                                                <twig:ux:icon name="lucide:user" class="h-4 w-4"/>
                                                {{ 'Delivery Person'|trans }}
                                            </span>
                                            <span class="text-yellow-600 dark:text-yellow-400 font-medium">{{ 'Not Assigned'|trans }}</span>
                                        </div>
                                    </div>
                                {% endif %}
                                {% if order.location %}
                                    <div class="p-3 bg-blue-50 dark:bg-blue-900/10 rounded-lg border border-blue-200 dark:border-blue-800">
                                        <div class="flex items-start justify-between">
                                            <span class="text-muted-foreground flex items-center gap-2">
                                                <twig:ux:icon name="lucide:map-pin" class="h-4 w-4"/>
                                                {{ 'Location'|trans }}
                                            </span>
                                            <div class="text-right">
                                                {% if order.location.address %}
                                                    <div class="font-medium">{{ order.location.address }}</div>
                                                {% endif %}
                                                {% if order.location.city %}
                                                    <div class="text-xs text-muted-foreground">{{ order.location.city }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                {% endif %}
                                <div class="grid grid-cols-2 gap-3">
                                    {% if order.scheduledDate %}
                                        <div class="p-3 bg-card rounded-lg border">
                                            <div class="text-xs text-muted-foreground mb-1">{{ 'Scheduled Date'|trans }}</div>
                                            <div class="font-medium text-sm">{{ order.scheduledDate|date('Y-m-d H:i') }}</div>
                                        </div>
                                    {% endif %}
                                    {% if order.deliveryFee %}
                                        <div class="p-3 bg-card rounded-lg border">
                                            <div class="text-xs text-muted-foreground mb-1">{{ 'Delivery Fee'|trans }}</div>
                                            <div class="font-medium text-sm">{{ order.deliveryFee|number_format(2, '.', ',') }} Ar</div>
                                        </div>
                                    {% endif %}
                                </div>
                                {% if order.estimatedDeliveryTime %}
                                    <div class="p-3 bg-card rounded-lg border">
                                        <div class="text-xs text-muted-foreground mb-1">{{ 'Estimated Delivery Time'|trans }}</div>
                                        <div class="font-medium text-sm">{{ order.estimatedDeliveryTime|date('Y-m-d H:i') }}</div>
                                    </div>
                                {% endif %}
                                {% if order.actualDeliveryTime %}
                                    <div class="p-3 bg-green-50 dark:bg-green-900/10 rounded-lg border border-green-200 dark:border-green-800">
                                        <div class="text-xs text-green-900 dark:text-green-300 mb-1">{{ 'Actual Delivery Time'|trans }}</div>
                                        <div class="font-medium text-sm text-green-900 dark:text-green-300">{{ order.actualDeliveryTime|date('Y-m-d H:i') }}</div>
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        {# Order Items #}
                        {% if order.items|length > 0 %}
                            <div class="border-t pt-4">
                                <div class="flex items-center justify-between mb-3">
                                    <h3 class="font-semibold">{{ 'Order Items'|trans }}</h3>
                                    <div class="flex items-center gap-2">
                                        {% set refused_count = order.items|filter(item => item.storeStatus.value == 'refused')|length %}
                                        {% set suggested_count = order.items|filter(item => item.storeStatus.value == 'suggested')|length %}
                                        {% if refused_count > 0 %}
                                            <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium bg-red-100 text-red-800 dark:bg-red-900/20 dark:text-red-400">
                                                <twig:ux:icon name="lucide:alert-circle" class="h-3 w-3 mr-1"/>
                                                {{ refused_count }} {{ 'Refused'|trans }}
                                            </span>
                                        {% endif %}
                                        {% if suggested_count > 0 %}
                                            <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium bg-yellow-100 text-yellow-800 dark:bg-yellow-900/20 dark:text-yellow-400">
                                                <twig:ux:icon name="lucide:lightbulb" class="h-3 w-3 mr-1"/>
                                                {{ suggested_count }} {{ 'Suggestions'|trans }}
                                            </span>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="space-y-3">
                                    {% for item in order.items %}
                                        {% set isRefused = item.storeStatus.value == 'refused' %}
                                        {% set isSuggested = item.storeStatus.value == 'suggested' %}
                                        <div class="p-4 bg-muted/50 rounded-lg {% if isRefused %}border-l-4 border-red-500{% elseif isSuggested %}border-l-4 border-yellow-500{% endif %}">
                                            <div class="flex items-start justify-between mb-3">
                                                <div class="flex-1">
                                                    <div class="flex items-center gap-2 mb-2">
                                                        <div class="font-medium text-base">{{ item.product ? item.product.name : 'N/A' }}</div>
                                                    </div>
                                                    
                                                    {# Store Name with Status Inline #}
                                                    {% if item.store %}
                                                        <div class="flex items-center gap-2 flex-wrap mb-2">
                                                            <span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900/20 dark:text-blue-400">
                                                                <twig:ux:icon name="lucide:store" class="h-3 w-3 mr-1"/>
                                                                {{ item.store.name }}
                                                            </span>
                                                            {% set storeStatusClass = item.storeStatus.value == 'accepted' ? 'bg-green-100 text-green-800 dark:bg-green-900/20 dark:text-green-400' : (item.storeStatus.value == 'refused' ? 'bg-red-100 text-red-800 dark:bg-red-900/20 dark:text-red-400' : (item.storeStatus.value == 'suggested' ? 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/20 dark:text-yellow-400' : (item.storeStatus.value == 'approved' ? 'bg-blue-100 text-blue-800 dark:bg-blue-900/20 dark:text-blue-400' : 'bg-gray-100 text-gray-800 dark:bg-gray-900/20 dark:text-gray-400'))) %}
                                                            <span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs font-medium {{ storeStatusClass }}">
                                                                {% if item.storeStatus.value == 'accepted' %}
                                                                    <twig:ux:icon name="lucide:check-circle" class="h-3 w-3 mr-1"/>
                                                                {% elseif item.storeStatus.value == 'refused' %}
                                                                    <twig:ux:icon name="lucide:x-circle" class="h-3 w-3 mr-1"/>
                                                                {% elseif item.storeStatus.value == 'suggested' %}
                                                                    <twig:ux:icon name="lucide:lightbulb" class="h-3 w-3 mr-1"/>
                                                                {% elseif item.storeStatus.value == 'approved' %}
                                                                    <twig:ux:icon name="lucide:check-circle-2" class="h-3 w-3 mr-1"/>
                                                                {% endif %}
                                                                {{ item.storeStatus.value|capitalize }}
                                                            </span>
                                                            {% if item.storeActionAt %}
                                                                <span class="text-xs text-muted-foreground">
                                                                    <twig:ux:icon name="lucide:clock" class="h-3 w-3 inline mr-1"/>
                                                                    {{ item.storeActionAt|date('Y-m-d H:i') }}
                                                                </span>
                                                            {% endif %}
                                                        </div>
                                                    {% endif %}
                                                    
                                                    {# Quantity and Price #}
                                                    <div class="flex items-center gap-4 mt-2">
                                                        <div class="text-sm text-muted-foreground">
                                                            <span class="font-medium">{{ 'Quantity'|trans }}:</span> {{ item.quantity }}
                                                        </div>
                                                        <div class="text-sm font-medium">
                                                            <span class="text-muted-foreground">{{ 'Price'|trans }}:</span> {{ item.totalPrice|number_format(2, '.', ',') }} Ar
                                                        </div>
                                                        {% if item.storePrice and item.storePrice != item.totalPrice %}
                                                            <div class="text-sm font-semibold text-green-600 dark:text-green-400">
                                                                <span class="text-muted-foreground">{{ 'Store Price'|trans }}:</span> {{ item.storePrice|number_format(2, '.', ',') }} Ar
                                                            </div>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            {# Refused Item Details #}
                                            {% if isRefused and item.storeNotes %}
                                                <div class="mt-3 p-3 bg-red-50 dark:bg-red-900/10 rounded border border-red-200 dark:border-red-800">
                                                    <div class="flex items-start gap-2">
                                                        <twig:ux:icon name="lucide:alert-triangle" class="h-4 w-4 text-red-600 dark:text-red-400 mt-0.5"/>
                                                        <div class="flex-1">
                                                            <div class="text-xs font-medium text-red-900 dark:text-red-300 mb-1">{{ 'Refusal Reason'|trans }}:</div>
                                                            <div class="text-sm text-red-800 dark:text-red-200">{{ item.storeNotes }}</div>
                                                        </div>
                                                    </div>
                                                </div>
                                            {% endif %}
                                            
                                            {# Suggestion Details - Enhanced and Prominent #}
                                            {% if isSuggested %}
                                                <div class="mt-3 p-4 bg-yellow-50 dark:bg-yellow-900/10 rounded-lg border-2 border-yellow-300 dark:border-yellow-700 shadow-sm">
                                                    <div class="flex items-center gap-2 mb-3">
                                                        <twig:ux:icon name="lucide:lightbulb" class="h-5 w-5 text-yellow-600 dark:text-yellow-400"/>
                                                        <div class="font-semibold text-yellow-900 dark:text-yellow-300 text-sm">{{ 'Store Suggestion'|trans }}</div>
                                                    </div>
                                                    {% if item.suggestedProduct %}
                                                        <div class="space-y-2">
                                                            <div class="flex items-center justify-between">
                                                                <div class="flex-1">
                                                                    <div class="text-xs font-medium text-yellow-900 dark:text-yellow-300 mb-1">{{ 'Suggested Alternative Product'|trans }}:</div>
                                                                    <div class="text-sm font-semibold text-yellow-900 dark:text-yellow-200">{{ item.suggestedProduct.name }}</div>
                                                                    {% if item.storeSuggestion %}
                                                                        <div class="text-xs text-yellow-800 dark:text-yellow-300 mt-2 p-2 bg-white dark:bg-yellow-950/20 rounded border border-yellow-200 dark:border-yellow-700">
                                                                            <span class="font-medium">{{ 'Store Note'|trans }}:</span> {{ item.storeSuggestion }}
                                                                        </div>
                                                                    {% endif %}
                                                                </div>
                                                                {% if item.storePrice %}
                                                                    <div class="ml-4 text-right">
                                                                        <div class="text-xs text-yellow-700 dark:text-yellow-400 mb-1">{{ 'Price'|trans }}</div>
                                                                        <div class="text-base font-bold text-yellow-900 dark:text-yellow-200">{{ item.storePrice|number_format(2, '.', ',') }} Ar</div>
                                                                    </div>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                    {% elseif item.storeSuggestion %}
                                                        <div class="flex items-start gap-2">
                                                            <twig:ux:icon name="lucide:message-square" class="h-4 w-4 text-yellow-600 dark:text-yellow-400 mt-0.5 flex-shrink-0"/>
                                                            <div class="flex-1">
                                                                <div class="text-xs font-medium text-yellow-900 dark:text-yellow-300 mb-1">{{ 'Suggestion'|trans }}:</div>
                                                                <div class="text-sm text-yellow-800 dark:text-yellow-200 leading-relaxed">{{ item.storeSuggestion }}</div>
                                                            </div>
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            {% endif %}
                                            
                                            {# Store Notes (for accepted items) #}
                                            {% if item.storeNotes and not isRefused and not isSuggested %}
                                                <div class="mt-3 text-xs p-2 bg-background rounded border">
                                                    <span class="font-medium">{{ 'Store Notes'|trans }}:</span> {{ item.storeNotes }}
                                                </div>
                                            {% endif %}
                                        </div>
                                    {% endfor %}
                                </div>
                                
                                {# Totals Summary - Enhanced #}
                                <div class="mt-4 grid gap-3">
                                    {% if order.storeTotalAmount %}
                                        <div class="p-3 bg-green-50 dark:bg-green-900/10 rounded-lg border border-green-200 dark:border-green-800">
                                            <div class="flex items-center justify-between">
                                                <span class="text-sm font-medium text-green-900 dark:text-green-300">
                                                    <twig:ux:icon name="lucide:store" class="h-4 w-4 inline mr-1"/>
                                                    {{ 'Store Total Amount'|trans }}
                                                </span>
                                                <span class="text-lg font-bold text-green-900 dark:text-green-300">{{ order.storeTotalAmount|number_format(2, '.', ',') }} Ar</span>
                                            </div>
                                        </div>
                                    {% endif %}
                                    <div class="p-3 bg-blue-50 dark:bg-blue-900/10 rounded-lg border border-blue-200 dark:border-blue-800">
                                        <div class="flex items-center justify-between">
                                            <span class="text-sm font-medium text-blue-900 dark:text-blue-300">
                                                <twig:ux:icon name="lucide:receipt" class="h-4 w-4 inline mr-1"/>
                                                {{ 'Order Total Amount'|trans }}
                                            </span>
                                            <span class="text-lg font-bold text-blue-900 dark:text-blue-300">{{ order.totalAmount|number_format(2, '.', ',') }} Ar</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endif %}

                        {# Notes #}
                        {% if order.notes %}
                            <div class="border-t pt-4">
                                <h3 class="font-semibold mb-2">{{ 'Notes'|trans }}</h3>
                                <p class="text-sm text-muted-foreground">{{ order.notes }}</p>
                            </div>
                        {% endif %}

                        {% if order.deliveryNotes %}
                            <div class="border-t pt-4">
                                <h3 class="font-semibold mb-2">{{ 'Delivery Notes'|trans }}</h3>
                                <p class="text-sm text-muted-foreground">{{ order.deliveryNotes }}</p>
                            </div>
                        {% endif %}
                    </twig:ui:card:content>
                </twig:ui:card:root>

                {# Order Summary Sidebar #}
                <div class="grid gap-6 h-fit">
                    <twig:ui:card:root>
                        <twig:ui:card:header>
                            <twig:ui:card:title>{{ 'Order Summary'|trans }}</twig:ui:card:title>
                        </twig:ui:card:header>
                        <twig:ui:card:content class="grid gap-4">
                            <div class="flex items-center justify-between pb-2 border-b">
                                <span class="text-sm text-muted-foreground">{{ 'Subtotal'|trans }}</span>
                                <span class="font-medium">{{ order.totalAmount|number_format(2, '.', ',') }} Ar</span>
                            </div>
                            {% if order.deliveryFee %}
                                <div class="flex items-center justify-between pb-2 border-b">
                                    <span class="text-sm text-muted-foreground">{{ 'Delivery Fee'|trans }}</span>
                                    <span class="font-medium">{{ order.deliveryFee|number_format(2, '.', ',') }} Ar</span>
                                </div>
                            {% endif %}
                            <div class="flex items-center justify-between">
                                <span class="font-semibold">{{ 'Total'|trans }}</span>
                                <span class="text-xl font-bold">{{ (order.totalAmount + (order.deliveryFee ?? 0))|number_format(2, '.', ',') }} Ar</span>
                            </div>
                        </twig:ui:card:content>
                    </twig:ui:card:root>

                    {# QR Code Card - Enhanced #}
                    {% if order.qrCode %}
                        <twig:ui:card:root>
                            <twig:ui:card:header>
                                <twig:ui:card:title>{{ 'QR Code'|trans }}</twig:ui:card:title>
                                <twig:ui:card:description>
                                    {{ 'Order verification code'|trans }}
                                </twig:ui:card:description>
                            </twig:ui:card:header>
                            <twig:ui:card:content class="grid gap-3">
                                <div class="p-4 bg-gradient-to-br from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 rounded-lg border-2 border-blue-200 dark:border-blue-800 text-center">
                                    <div class="mb-3">
                                        <twig:ux:icon name="lucide:scan" class="h-12 w-12 mx-auto text-blue-600 dark:text-blue-400"/>
                                    </div>
                                    <div class="font-mono text-lg font-bold text-blue-900 dark:text-blue-100 break-all mb-2">
                                        {{ order.qrCode }}
                                    </div>
                                    {% if order.qrCodeValidatedAt %}
                                        <div class="inline-flex items-center gap-2 px-3 py-1.5 bg-green-100 dark:bg-green-900/20 text-green-800 dark:text-green-300 rounded-full text-xs font-medium">
                                            <twig:ux:icon name="lucide:check-circle" class="h-4 w-4"/>
                                            {{ 'Validated'|trans }} {{ order.qrCodeValidatedAt|date('Y-m-d H:i') }}
                                        </div>
                                    {% else %}
                                        <div class="inline-flex items-center gap-2 px-3 py-1.5 bg-yellow-100 dark:bg-yellow-900/20 text-yellow-800 dark:text-yellow-300 rounded-full text-xs font-medium">
                                            <twig:ux:icon name="lucide:clock" class="h-4 w-4"/>
                                            {{ 'Pending Validation'|trans }}
                                        </div>
                                    {% endif %}
                                </div>
                                {# Store-specific QR Codes #}
                                {% set unique_stores_qr = [] %}
                                {% set unique_store_ids_qr = [] %}
                                {% for item in order.items %}
                                    {% if item.store and item.store.id not in unique_store_ids_qr %}
                                        {% set unique_stores_qr = unique_stores_qr|merge([item.store]) %}
                                        {% set unique_store_ids_qr = unique_store_ids_qr|merge([item.store.id]) %}
                                    {% endif %}
                                {% endfor %}
                                {% if unique_stores_qr|length > 0 %}
                                    <div class="border-t pt-3 mt-2">
                                        <div class="text-xs font-medium text-muted-foreground mb-2">{{ 'Store QR Codes'|trans }}</div>
                                        <div class="space-y-2">
                                            {% for store in unique_stores_qr %}
                                                <div class="p-2 bg-muted rounded border text-xs">
                                                    <div class="flex items-center justify-between">
                                                        <span class="font-medium">{{ store.name }}</span>
                                                        <span class="font-mono text-blue-600 dark:text-blue-400">{{ order.qrCode }}</span>
                                                    </div>
                                                </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                {% endif %}
                            </twig:ui:card:content>
                        </twig:ui:card:root>
                    {% endif %}

                    {# Tracking Information - Enhanced #}
                    <twig:ui:card:root>
                        <twig:ui:card:header>
                            <twig:ui:card:title>{{ 'Delivery Tracking'|trans }}</twig:ui:card:title>
                        </twig:ui:card:header>
                        <twig:ui:card:content class="grid gap-3 text-sm">
                            <div class="relative">
                                {# Timeline Line #}
                                <div class="absolute left-3 top-0 bottom-0 w-0.5 bg-gray-200 dark:bg-gray-700"></div>
                                
                                {% if order.acceptedAt %}
                                    <div class="relative flex items-start gap-3 pb-4">
                                        <div class="relative z-10 flex h-6 w-6 items-center justify-center rounded-full bg-green-500 ring-2 ring-white dark:ring-gray-900">
                                            <twig:ux:icon name="lucide:check" class="h-3 w-3 text-white"/>
                                        </div>
                                        <div class="flex-1 pt-0.5">
                                            <div class="font-medium text-green-700 dark:text-green-400">{{ 'Accepted'|trans }}</div>
                                            <div class="text-xs text-muted-foreground">{{ order.acceptedAt|date('F d, Y \a\t H:i') }}</div>
                                        </div>
                                    </div>
                                {% else %}
                                    <div class="relative flex items-start gap-3 pb-4">
                                        <div class="relative z-10 flex h-6 w-6 items-center justify-center rounded-full bg-gray-300 dark:bg-gray-600 ring-2 ring-white dark:ring-gray-900">
                                            <div class="h-2 w-2 rounded-full bg-gray-500 dark:bg-gray-400"></div>
                                        </div>
                                        <div class="flex-1 pt-0.5">
                                            <div class="font-medium text-muted-foreground">{{ 'Accepted'|trans }}</div>
                                            <div class="text-xs text-muted-foreground">{{ 'Not yet'|trans }}</div>
                                        </div>
                                    </div>
                                {% endif %}
                                
                                {% if order.pickedUpAt %}
                                    <div class="relative flex items-start gap-3 pb-4">
                                        <div class="relative z-10 flex h-6 w-6 items-center justify-center rounded-full bg-blue-500 ring-2 ring-white dark:ring-gray-900">
                                            <twig:ux:icon name="lucide:package" class="h-3 w-3 text-white"/>
                                        </div>
                                        <div class="flex-1 pt-0.5">
                                            <div class="font-medium text-blue-700 dark:text-blue-400">{{ 'Picked Up'|trans }}</div>
                                            <div class="text-xs text-muted-foreground">{{ order.pickedUpAt|date('F d, Y \a\t H:i') }}</div>
                                        </div>
                                    </div>
                                {% else %}
                                    <div class="relative flex items-start gap-3 pb-4">
                                        <div class="relative z-10 flex h-6 w-6 items-center justify-center rounded-full bg-gray-300 dark:bg-gray-600 ring-2 ring-white dark:ring-gray-900">
                                            <div class="h-2 w-2 rounded-full bg-gray-500 dark:bg-gray-400"></div>
                                        </div>
                                        <div class="flex-1 pt-0.5">
                                            <div class="font-medium text-muted-foreground">{{ 'Picked Up'|trans }}</div>
                                            <div class="text-xs text-muted-foreground">{{ 'Not yet'|trans }}</div>
                                        </div>
                                    </div>
                                {% endif %}
                                
                                {% if order.deliveredAt %}
                                    <div class="relative flex items-start gap-3">
                                        <div class="relative z-10 flex h-6 w-6 items-center justify-center rounded-full bg-green-500 ring-2 ring-white dark:ring-gray-900">
                                            <twig:ux:icon name="lucide:check-circle" class="h-3 w-3 text-white"/>
                                        </div>
                                        <div class="flex-1 pt-0.5">
                                            <div class="font-medium text-green-700 dark:text-green-400">{{ 'Delivered'|trans }}</div>
                                            <div class="text-xs text-muted-foreground">{{ order.deliveredAt|date('F d, Y \a\t H:i') }}</div>
                                        </div>
                                    </div>
                                {% else %}
                                    <div class="relative flex items-start gap-3">
                                        <div class="relative z-10 flex h-6 w-6 items-center justify-center rounded-full bg-gray-300 dark:bg-gray-600 ring-2 ring-white dark:ring-gray-900">
                                            <div class="h-2 w-2 rounded-full bg-gray-500 dark:bg-gray-400"></div>
                                        </div>
                                        <div class="flex-1 pt-0.5">
                                            <div class="font-medium text-muted-foreground">{{ 'Delivered'|trans }}</div>
                                            <div class="text-xs text-muted-foreground">{{ 'Not yet'|trans }}</div>
                                        </div>
                                    </div>
                                {% endif %}
                            </div>
                        </twig:ui:card:content>
                    </twig:ui:card:root>

                    {# Actions #}
                    <twig:ui:card:root>
                        <twig:ui:card:header>
                            <twig:ui:card:title>{{ 'Actions'|trans }}</twig:ui:card:title>
                        </twig:ui:card:header>
                        <twig:ui:card:content class="grid gap-2">
                            <twig:ui:button:root href="{{ path('admin_order_edit', {id: order.id}) }}" variant="outline" class="w-full">
                                <twig:ux:icon name="lucide:edit" class="h-4 w-4 mr-2"/>
                                {{ 'Edit Order'|trans }}
                            </twig:ui:button:root>
                            <form method="post" action="{{ path('admin_order_delete', {id: order.id}) }}" onsubmit="return confirm('{{ 'Are you sure you want to delete this order?'|trans }}');">
                                <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ order.id) }}">
                                <twig:ui:button:root type="submit" variant="destructive" class="w-full">
                                    <twig:ux:icon name="lucide:trash" class="h-4 w-4 mr-2"/>
                                    {{ 'Delete Order'|trans }}
                                </twig:ui:button:root>
                            </form>
                        </twig:ui:card:content>
                    </twig:ui:card:root>
                </div>
            </div>
        </div>
    </main>
{% endblock %}

