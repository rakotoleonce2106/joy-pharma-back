{% extends 'admin/layout.html.twig' %}

{% block title %}Dashboard{% endblock %}

{% block head %}
    {{ parent() }}
    {# Leaflet CSS for maps #}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
    <style>
        /* Map container with fixed height */
        #dashboard-map {
            height: 300px !important;
            max-height: 300px !important;
            min-height: 300px !important;
            width: 100%;
            z-index: 1;
            overflow: hidden !important;
            position: relative;
        }
        
        /* Leaflet specific containers */
        #dashboard-map .leaflet-container,
        #dashboard-map .leaflet-pane,
        #dashboard-map .leaflet-map-pane {
            height: 300px !important;
            max-height: 300px !important;
            overflow: hidden !important;
        }
        
        /* Prevent markers from extending beyond container */
        #dashboard-map .leaflet-marker-pane,
        #dashboard-map .leaflet-popup-pane,
        #dashboard-map .leaflet-shadow-pane {
            max-height: 300px !important;
        }
        .pulse-dot {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: .5;
            }
        }
        @keyframes map-pulse {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.05);
                opacity: 0.8;
            }
        }
        .leaflet-popup-content-wrapper {
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
        }
        .leaflet-popup-tip {
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
        }
        .custom-div-icon {
            background: none !important;
            border: none !important;
        }
        .driver-marker {
            position: relative;
            animation: map-pulse 2s infinite;
        }
        .price-badge {
            background: white;
            color: #dc2626;
            font-weight: bold;
            font-size: 9px;
            padding: 2px 5px;
            border-radius: 6px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
            margin-top: 2px;
            white-space: nowrap;
        }
        .driver-name-badge {
            background: white;
            color: #16a34a;
            font-weight: 600;
            font-size: 9px;
            padding: 2px 5px;
            border-radius: 5px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
            margin-top: 2px;
            white-space: nowrap;
        }
    </style>
{% endblock %}

{% block content %}
    <main class="flex flex-1 flex-col gap-6 p-4 md:gap-8 md:p-8 w-[85rem]">
        {# Header with Page Title and Real-time Indicator #}
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold tracking-tight">Dashboard</h1>
                <p class="text-muted-foreground">Welcome back! Here's what's happening today.</p>
            </div>
            <div class="flex items-center gap-2 px-3 py-2 bg-card border rounded-lg">
                <span class="relative flex h-3 w-3">
                    <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                    <span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
                </span>
                <span class="text-sm font-medium">Live</span>
            </div>
        </div>

        {# Top Statistics Cards #}
        <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-4">
            {# Today's Revenue #}
            <twig:ui:card:root>
                <twig:ui:card:header class="flex flex-row items-center justify-between space-y-0 pb-2">
                    <twig:ui:card:title class="text-sm font-medium">Today's Revenue</twig:ui:card:title>
                    <div class="h-8 w-8 rounded-full bg-green-100 dark:bg-green-900/20 flex items-center justify-center">
                        <twig:ux:icon name="lucide:trending-up" class="h-4 w-4 text-green-600 dark:text-green-400"/>
                    </div>
                </twig:ui:card:header>
                <twig:ui:card:content>
                    <div class="text-2xl font-bold">{{ todayRevenue|number_format(0, '.', ',') }} Ar</div>
                    <p class="text-xs text-muted-foreground mt-1">
                        <span class="text-green-600 dark:text-green-400 font-medium">{{ todayOrders }} orders</span> today
                    </p>
                </twig:ui:card:content>
            </twig:ui:card:root>

            {# Total Revenue #}
            <twig:ui:card:root>
                <twig:ui:card:header class="flex flex-row items-center justify-between space-y-0 pb-2">
                    <twig:ui:card:title class="text-sm font-medium">Total Revenue</twig:ui:card:title>
                    <div class="h-8 w-8 rounded-full bg-blue-100 dark:bg-blue-900/20 flex items-center justify-center">
                        <twig:ux:icon name="lucide:dollar-sign" class="h-4 w-4 text-blue-600 dark:text-blue-400"/>
                    </div>
                </twig:ui:card:header>
                <twig:ui:card:content>
                    <div class="text-2xl font-bold">{{ totalRevenue|number_format(0, '.', ',') }} Ar</div>
                    <p class="text-xs text-muted-foreground mt-1">
                        {% if lastMonthRevenue > 0 %}
                            {% set percentChange = ((totalRevenue - lastMonthRevenue) / lastMonthRevenue * 100)|round(1) %}
                            <span class="{% if percentChange > 0 %}text-green-600 dark:text-green-400{% else %}text-red-600 dark:text-red-400{% endif %} font-medium">
                                {{ percentChange > 0 ? '+' : '' }}{{ percentChange }}%
                            </span> from last month
                        {% else %}
                            All time revenue
                        {% endif %}
                    </p>
                </twig:ui:card:content>
            </twig:ui:card:root>

            {# Active Orders #}
            <twig:ui:card:root>
                <twig:ui:card:header class="flex flex-row items-center justify-between space-y-0 pb-2">
                    <twig:ui:card:title class="text-sm font-medium">Active Orders</twig:ui:card:title>
                    <div class="h-8 w-8 rounded-full bg-amber-100 dark:bg-amber-900/20 flex items-center justify-center">
                        <twig:ux:icon name="lucide:shopping-cart" class="h-4 w-4 text-amber-600 dark:text-amber-400"/>
                    </div>
                </twig:ui:card:header>
                <twig:ui:card:content>
                    <div class="text-2xl font-bold">{{ pendingOrders }}</div>
                    <p class="text-xs text-muted-foreground mt-1">
                        <span class="text-amber-600 dark:text-amber-400 font-medium">{{ totalOrders }}</span> total orders
                    </p>
                </twig:ui:card:content>
            </twig:ui:card:root>

            {# Online Delivers #}
            <twig:ui:card:root>
                <twig:ui:card:header class="flex flex-row items-center justify-between space-y-0 pb-2">
                    <twig:ui:card:title class="text-sm font-medium">Delivers Online</twig:ui:card:title>
                    <div class="h-8 w-8 rounded-full bg-purple-100 dark:bg-purple-900/20 flex items-center justify-center">
                        <twig:ux:icon name="lucide:bike" class="h-4 w-4 text-purple-600 dark:text-purple-400"/>
                    </div>
                </twig:ui:card:header>
                <twig:ui:card:content>
                    <div class="text-2xl font-bold">{{ onlineDeliversCount }}/{{ totalDelivers }}</div>
                    <p class="text-xs text-muted-foreground mt-1">
                        <span class="{% if onlineDeliversCount > 0 %}text-green-600 dark:text-green-400{% else %}text-muted-foreground{% endif %} font-medium">
                            {{ onlineDeliversCount > 0 ? 'Available now' : 'None available' }}
                        </span>
                    </p>
                </twig:ui:card:content>
            </twig:ui:card:root>
        </div>

        {# Map Section #}
        <twig:ui:card:root class="overflow-hidden">
            <twig:ui:card:header class="bg-gradient-to-r from-primary/5 to-primary/10">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                    <div>
                        <div class="flex items-center gap-2 mb-2">
                            <div class="h-10 w-10 rounded-full bg-primary/10 flex items-center justify-center">
                                <twig:ux:icon name="lucide:map" class="h-5 w-5 text-primary"/>
                            </div>
                            <twig:ui:card:title class="text-xl">Real-Time Tracking</twig:ui:card:title>
                        </div>
                        <twig:ui:card:description class="text-base">
                            Live map showing stores, delivery drivers locations, and pending orders
                        </twig:ui:card:description>
                    </div>
                    <div class="flex flex-wrap items-center gap-4 text-sm bg-card px-4 py-3 rounded-lg border">
                        <div class="flex items-center gap-2">
                            <div class="w-4 h-4 rounded-full bg-blue-500 shadow-sm"></div>
                            <span class="font-medium text-foreground">{{ stores|length }}</span>
                            <span class="text-muted-foreground">Stores</span>
                        </div>
                        <div class="w-px h-6 bg-border"></div>
                        <div class="flex items-center gap-2">
                            <div class="w-4 h-4 rounded-full bg-green-500 shadow-sm pulse-dot"></div>
                            <span class="font-medium text-foreground">{{ onlineDeliversCount }}</span>
                            <span class="text-muted-foreground">Online</span>
                        </div>
                        <div class="w-px h-6 bg-border"></div>
                        <div class="flex items-center gap-2">
                            <div class="w-4 h-4 rounded-full bg-red-500 shadow-sm"></div>
                            <span class="font-medium text-foreground">{{ ordersWithLocations|length }}</span>
                            <span class="text-muted-foreground">Orders</span>
                        </div>
                    </div>
                </div>
            </twig:ui:card:header>
            <twig:ui:card:content class="p-0 !h-[300px] !max-h-[300px] overflow-hidden">
                <div id="dashboard-map" class="w-full"></div>
            </twig:ui:card:content>
        </twig:ui:card:root>

        {# Main Content Grid #}
        <div class="grid gap-6 lg:grid-cols-3">
            {# Online Delivers List #}
            <twig:ui:card:root>
                <twig:ui:card:header>
                    <twig:ui:card:title>Delivery Drivers Online</twig:ui:card:title>
                    <twig:ui:card:description>
                        {{ onlineDeliversCount }} drivers currently active
                    </twig:ui:card:description>
                </twig:ui:card:header>
                <twig:ui:card:content>
                    {% if onlineDelivers|length > 0 %}
                        <div class="space-y-4">
                            {% for deliver in onlineDelivers %}
                                <div class="flex items-center gap-4 p-3 rounded-lg border bg-card hover:bg-muted/50 transition-colors">
                                    <div class="relative">
                                        <div class="h-10 w-10 rounded-full bg-gradient-to-br from-green-400 to-green-600 flex items-center justify-center text-white font-semibold">
                                            {{ deliver.user.firstName|first }}{{ deliver.user.lastName|first }}
                                        </div>
                                        <span class="absolute bottom-0 right-0 h-3 w-3 rounded-full bg-green-500 border-2 border-white dark:border-gray-900 pulse-dot"></span>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <p class="font-medium text-sm">{{ deliver.user.fullName }}</p>
                                        <p class="text-xs text-muted-foreground truncate">{{ deliver.user.email }}</p>
                                        {% if deliver.location and deliver.location.updatedAt %}
                                            <p class="text-xs text-green-600 dark:text-green-400 mt-1">
                                                Last update {{ deliver.location.updatedAt|date('H:i') }}
                                            </p>
                                        {% endif %}
                                    </div>
                                    <twig:ui:button:root size="sm" variant="ghost" onclick="focusOnDeliver({{ deliver.location ? deliver.location.latitude : 0 }}, {{ deliver.location ? deliver.location.longitude : 0 }})">
                                        <twig:ux:icon name="lucide:map-pin" class="h-4 w-4"/>
                                    </twig:ui:button:root>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="flex flex-col items-center justify-center py-8 text-center">
                            <div class="h-12 w-12 rounded-full bg-muted flex items-center justify-center mb-3">
                                <twig:ux:icon name="lucide:bike" class="h-6 w-6 text-muted-foreground"/>
                            </div>
                            <p class="text-sm font-medium mb-1">No Drivers Online</p>
                            <p class="text-xs text-muted-foreground">Waiting for drivers to come online</p>
                        </div>
                    {% endif %}
                </twig:ui:card:content>
            </twig:ui:card:root>

            {# Available Orders and Quick Stats #}
            <div class="lg:col-span-2 space-y-6">
                {# Available Orders #}
                <twig:ui:card:root>
                    <twig:ui:card:header class="flex flex-row items-center">
                        <div class="grid gap-2">
                            <twig:ui:card:title>Available Orders</twig:ui:card:title>
                            <twig:ui:card:description>
                                Pending orders waiting for assignment
                            </twig:ui:card:description>
                        </div>
                        <twig:ui:button:root size="sm" href="{{ path('admin_order') }}" class="ml-auto gap-1" data-turbo-frame="_top">
                            View All
                            <twig:ux:icon name="lucide:arrow-up-right" class="h-4 w-4"/>
                        </twig:ui:button:root>
                    </twig:ui:card:header>
                    <twig:ui:card:content>
                        {% if availableOrders|length > 0 %}
                            <div class="space-y-3">
                                {% for order in availableOrders|slice(0, 5) %}
                                    <div class="flex items-center justify-between p-3 rounded-lg border bg-card hover:bg-muted/30 transition-all cursor-pointer" onclick="focusOnOrder('{{ order.reference }}')">
                                        <div class="flex items-center gap-4">
                                            <div class="h-10 w-10 rounded-lg bg-gradient-to-br from-red-400 to-red-600 flex items-center justify-center text-white font-bold text-sm">
                                                {% if order.priority.value == 'urgent' %}
                                                    <twig:ux:icon name="lucide:alert-circle" class="h-5 w-5"/>
                                                {% else %}
                                                    <twig:ux:icon name="lucide:shopping-bag" class="h-5 w-5"/>
                                                {% endif %}
                                            </div>
                                            <div>
                                                <p class="font-medium text-sm">{{ order.reference }}</p>
                                                <p class="text-xs text-muted-foreground">
                                                    {{ order.owner ? order.owner.fullName : 'Guest' }}
                                                </p>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <p class="font-bold text-sm">{{ order.totalAmount|number_format(0) }} Ar</p>
                                            <p class="text-xs text-muted-foreground">{{ order.createdAt|date('H:i') }}</p>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="flex flex-col items-center justify-center py-8 text-center">
                                <p class="text-sm font-medium mb-1">All Caught Up!</p>
                                <p class="text-xs text-muted-foreground">No pending orders at the moment</p>
                            </div>
                        {% endif %}
                    </twig:ui:card:content>
                </twig:ui:card:root>

                {# Quick Stats Grid #}
                <div class="grid gap-4 md:grid-cols-3">
                    <twig:ui:card:root>
                        <twig:ui:card:content class="pt-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-muted-foreground">Stores</p>
                                    <p class="text-2xl font-bold">{{ totalStores }}</p>
                                </div>
                                <twig:ux:icon name="lucide:store" class="h-8 w-8 text-muted-foreground"/>
                            </div>
                        </twig:ui:card:content>
                    </twig:ui:card:root>

                    <twig:ui:card:root>
                        <twig:ui:card:content class="pt-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-muted-foreground">Products</p>
                                    <p class="text-2xl font-bold">{{ totalProducts }}</p>
                                </div>
                                <twig:ux:icon name="lucide:package" class="h-8 w-8 text-muted-foreground"/>
                            </div>
                        </twig:ui:card:content>
                    </twig:ui:card:root>

                    <twig:ui:card:root>
                        <twig:ui:card:content class="pt-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-muted-foreground">Users</p>
                                    <p class="text-2xl font-bold">{{ totalUsers }}</p>
                                </div>
                                <twig:ux:icon name="lucide:users-round" class="h-8 w-8 text-muted-foreground"/>
                            </div>
                        </twig:ui:card:content>
                    </twig:ui:card:root>
                </div>
            </div>
        </div>

        {# Recent Orders Section #}
        <twig:ui:card:root>
            <twig:ui:card:header class="flex flex-row items-center">
                <div class="grid gap-2">
                    <twig:ui:card:title>Recent Orders</twig:ui:card:title>
                    <twig:ui:card:description>
                        Latest orders from your system
                    </twig:ui:card:description>
                </div>
                <twig:ui:button:root size="sm" href="{{ path('admin_order') }}" class="ml-auto gap-1" data-turbo-frame="_top">
                    View All
                    <twig:ux:icon name="lucide:arrow-up-right" class="h-4 w-4"/>
                </twig:ui:button:root>
            </twig:ui:card:header>
            <twig:ui:card:content>
                {% if recentOrders|length > 0 %}
                    <twig:ui:table:root>
                        <twig:ui:table:header>
                            <twig:ui:table:row>
                                <twig:ui:table:head>Reference</twig:ui:table:head>
                                <twig:ui:table:head>Customer</twig:ui:table:head>
                                <twig:ui:table:head class="hidden lg:table-cell">Status</twig:ui:table:head>
                                <twig:ui:table:head class="hidden md:table-cell">Date</twig:ui:table:head>
                                <twig:ui:table:head class="text-right">Amount</twig:ui:table:head>
                            </twig:ui:table:row>
                        </twig:ui:table:header>
                        <twig:ui:table:body>
                            {% for order in recentOrders %}
                                <twig:ui:table:row>
                                    <twig:ui:table:cell class="font-medium">
                                        <a href="{{ path('admin_order_view', {id: order.id}) }}" class="hover:underline">
                                            {{ order.reference }}
                                        </a>
                                    </twig:ui:table:cell>
                                    <twig:ui:table:cell>
                                        {% if order.owner %}
                                            <div class="font-medium">{{ order.owner.fullName }}</div>
                                            <div class="hidden text-sm text-muted-foreground md:inline">
                                                {{ order.owner.email }}
                                            </div>
                                        {% else %}
                                            <span class="text-muted-foreground">Guest</span>
                                        {% endif %}
                                    </twig:ui:table:cell>
                                    <twig:ui:table:cell class="hidden lg:table-cell">
                                        {% set statusClass = order.status.value == 'delivered' ? 'bg-green-100 text-green-800 dark:bg-green-900/20 dark:text-green-400' : (order.status.value == 'cancelled' ? 'bg-red-100 text-red-800 dark:bg-red-900/20 dark:text-red-400' : (order.status.value == 'pending' ? 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/20 dark:text-yellow-400' : 'bg-blue-100 text-blue-800 dark:bg-blue-900/20 dark:text-blue-400')) %}
                                        <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium {{ statusClass }}">
                                            {{ order.status.value|capitalize }}
                                        </span>
                                    </twig:ui:table:cell>
                                    <twig:ui:table:cell class="hidden md:table-cell text-muted-foreground">
                                        {{ order.createdAt|date('Y-m-d H:i') }}
                                    </twig:ui:table:cell>
                                    <twig:ui:table:cell class="text-right font-semibold">{{ order.totalAmount|number_format(0) }} Ar</twig:ui:table:cell>
                                </twig:ui:table:row>
                            {% endfor %}
                        </twig:ui:table:body>
                    </twig:ui:table:root>
                {% else %}
                    <div class="flex flex-col items-center justify-center py-8 text-center">
                        <twig:ux:icon name="lucide:shopping-cart" class="h-12 w-12 text-muted-foreground mb-4"/>
                        <p class="text-sm text-muted-foreground">No orders yet</p>
                    </div>
                {% endif %}
            </twig:ui:card:content>
        </twig:ui:card:root>
    </main>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    {# Leaflet JS #}
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Initializing dashboard map...');
            console.log('Leaflet loaded:', typeof L !== 'undefined');
            
            // Check if map div exists
            const mapDiv = document.getElementById('dashboard-map');
            console.log('Map div found:', mapDiv !== null);
            if (!mapDiv) {
                console.error('Map div not found!');
                return;
            }
            
            // Initialize map with specific options
            const map = L.map('dashboard-map', {
                scrollWheelZoom: true,
                zoomControl: true,
                attributionControl: true,
                dragging: true
            }).setView([-18.8792, 47.5079], 13); // Antananarivo, Madagascar

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 19
            }).addTo(map);
            
            console.log('Map initialized successfully');
            
            // Force map to redraw after initialization and set explicit height
            setTimeout(() => {
                const mapContainer = document.getElementById('dashboard-map');
                if (mapContainer) {
                    mapContainer.style.height = '300px';
                    mapContainer.style.maxHeight = '300px';
                    mapContainer.style.overflow = 'hidden';
                }
                map.invalidateSize();
                console.log('Map size invalidated and height enforced');
            }, 100);

        // Function to create store icon (pharmacy)
        function createStoreIcon(storeName) {
            return L.divIcon({
                className: 'custom-div-icon',
                html: `
                    <div style="display: flex; flex-direction: column; align-items: center;">
                        <div style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); width: 32px; height: 32px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 8px rgba(59, 130, 246, 0.4); display: flex; align-items: center; justify-content: center;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="white">
                                <path d="M9 2v6H6v2h3v2H7v2h2v2H7v2h2v4h6v-4h2v-2h-2v-2h2v-2h-2v-2h3V8h-3V2H9zm2 2h2v4h-2V4zm-2 6h6v2h-2v2h-2v-2H9v-2z"/>
                            </svg>
                        </div>
                        <div style="background: white; color: #2563eb; font-weight: 600; font-size: 9px; padding: 2px 6px; border-radius: 6px; box-shadow: 0 2px 6px rgba(0,0,0,0.15); margin-top: 2px; white-space: nowrap; max-width: 80px; overflow: hidden; text-overflow: ellipsis;">
                            ${storeName}
                        </div>
                    </div>
                `,
                iconSize: [80, 55],
                iconAnchor: [40, 28],
                popupAnchor: [0, -28]
            });
        }

        // Function to create deliver icon with name
        function createDeliverIcon(firstName, lastName) {
            const initials = (firstName.charAt(0) + lastName.charAt(0)).toUpperCase();
            const displayName = `${firstName} ${lastName}`;
            return L.divIcon({
                className: 'custom-div-icon',
                html: `
                    <div class="driver-marker" style="display: flex; flex-direction: column; align-items: center;">
                        <div style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); width: 34px; height: 34px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 8px rgba(34, 197, 94, 0.4); display: flex; align-items: center; justify-content: center; position: relative;">
                            <span style="color: white; font-weight: bold; font-size: 12px;">${initials}</span>
                            <div style="position: absolute; bottom: -1px; right: -1px; width: 10px; height: 10px; background: #22c55e; border: 2px solid white; border-radius: 50%; animation: map-pulse 2s infinite;"></div>
                        </div>
                        <div class="driver-name-badge" style="margin-top: 2px; font-size: 9px; padding: 2px 5px;">
                            üö¥ ${displayName}
                        </div>
                    </div>
                `,
                iconSize: [100, 55],
                iconAnchor: [50, 28],
                popupAnchor: [0, -28]
            });
        }

        // Function to create order icon with price
        function createOrderIcon(price, reference) {
            const formattedPrice = new Intl.NumberFormat('fr-MG').format(price);
            return L.divIcon({
                className: 'custom-div-icon',
                html: `
                    <div style="display: flex; flex-direction: column; align-items: center;">
                        <div style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); width: 32px; height: 32px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4); display: flex; align-items: center; justify-content: center;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="9" cy="21" r="1"/>
                                <circle cx="20" cy="21" r="1"/>
                                <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/>
                            </svg>
                        </div>
                        <div class="price-badge" style="margin-top: 2px; font-size: 9px; padding: 2px 5px;">
                            üí∞ ${formattedPrice} Ar
                        </div>
                    </div>
                `,
                iconSize: [100, 55],
                iconAnchor: [50, 28],
                popupAnchor: [0, -28]
            });
        }

        // Add stores to map with enhanced popups
        const stores = {{ stores|json_encode|raw }};
        console.log('Stores data:', stores);
        stores.forEach(store => {
            if (store.location && store.location.latitude && store.location.longitude) {
                const storeIcon = createStoreIcon(store.name);
                L.marker([store.location.latitude, store.location.longitude], {icon: storeIcon})
                    .addTo(map)
                    .bindPopup(`
                        <div style="font-family: system-ui, -apple-system, sans-serif; min-width: 220px;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 2px solid #e2e8f0;">
                                <div style="width: 10px; height: 10px; border-radius: 50%; background: #3b82f6;"></div>
                                <strong style="font-size: 15px; color: #1e293b;">üè™ ${store.name}</strong>
                            </div>
                            <div style="font-size: 12px; color: #64748b; line-height: 1.6;">
                                <div style="margin-bottom: 4px;">
                                    <strong style="color: #475569;">Address:</strong>
                                </div>
                                <div style="padding-left: 8px;">
                                    üìç ${store.location.address || 'Store location'}
                                </div>
                            </div>
                        </div>
                    `);
            }
        });

        // Add online delivers to map with enhanced popups
        const onlineDelivers = {{ onlineDeliversData|json_encode|raw }};
        console.log('Online delivers data:', onlineDelivers);
        onlineDelivers.forEach(deliver => {
            if (deliver.deliveryLocation && deliver.deliveryLocation.latitude && deliver.deliveryLocation.longitude) {
                const deliverIcon = createDeliverIcon(deliver.firstName, deliver.lastName);
                L.marker([deliver.deliveryLocation.latitude, deliver.deliveryLocation.longitude], {icon: deliverIcon})
                    .addTo(map)
                    .bindPopup(`
                        <div style="font-family: system-ui, -apple-system, sans-serif; min-width: 240px;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 2px solid #e2e8f0;">
                                <div style="width: 10px; height: 10px; border-radius: 50%; background: #22c55e; animation: pulse 2s infinite;"></div>
                                <strong style="font-size: 15px; color: #1e293b;">üö¥ ${deliver.firstName} ${deliver.lastName}</strong>
                            </div>
                            <div style="font-size: 12px; color: #64748b; line-height: 1.6;">
                                <div style="background: #f0fdf4; border-left: 3px solid #22c55e; padding: 8px; border-radius: 4px; margin-bottom: 8px;">
                                    <div style="color: #16a34a; font-weight: 600;">‚úì Driver Online</div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 6px;">
                                    <span>‚è∞</span>
                                    <span style="color: #475569;">Last update: ${new Date(deliver.deliveryLocation.updatedAt.date).toLocaleTimeString('fr-FR')}</span>
                                </div>
                                ${deliver.deliveryLocation.address ? `
                                    <div style="display: flex; align-items: start; gap: 6px; margin-top: 6px;">
                                        <span>üìç</span>
                                        <span style="color: #475569;">${deliver.deliveryLocation.address}</span>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `);
            }
        });

        // Add orders with locations to map with enhanced popups
        const ordersWithLocations = {{ ordersWithLocations|json_encode|raw }};
        console.log('Orders with locations data:', ordersWithLocations);
        const orderMarkers = {};
        ordersWithLocations.forEach(order => {
            if (order.location && order.location.latitude && order.location.longitude) {
                const orderIcon = createOrderIcon(order.totalAmount, order.reference);
                const marker = L.marker([order.location.latitude, order.location.longitude], {icon: orderIcon})
                    .addTo(map)
                    .bindPopup(`
                        <div style="font-family: system-ui, -apple-system, sans-serif; min-width: 260px;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 2px solid #e2e8f0;">
                                <div style="width: 10px; height: 10px; border-radius: 50%; background: #ef4444;"></div>
                                <strong style="font-size: 15px; color: #1e293b;">üõí Order: ${order.reference}</strong>
                            </div>
                            <div style="font-size: 12px; line-height: 1.6;">
                                <div style="background: #fef2f2; border-left: 3px solid #ef4444; padding: 10px; border-radius: 4px; margin-bottom: 10px;">
                                    <div style="font-size: 16px; font-weight: bold; color: #dc2626; margin-bottom: 4px;">
                                        üí∞ ${new Intl.NumberFormat('fr-MG').format(order.totalAmount)} Ar
                                    </div>
                                    <div style="font-size: 11px; color: #991b1b;">
                                        Total amount
                                    </div>
                                </div>
                                ${order.location.address ? `
                                    <div style="display: flex; align-items: start; gap: 6px; color: #475569;">
                                        <span style="flex-shrink: 0;">üìç</span>
                                        <div>
                                            <strong style="display: block; margin-bottom: 2px; color: #1e293b;">Delivery Address:</strong>
                                            <span>${order.location.address}</span>
                                        </div>
                                    </div>
                                ` : ''}
                                ${order.status ? `
                                    <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #e2e8f0;">
                                        <span style="color: #64748b;">Status: </span>
                                        <span style="font-weight: 600; color: #ef4444; text-transform: capitalize;">${order.status}</span>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `);
                orderMarkers[order.reference] = marker;
            }
        });

        // Helper function to focus on deliver
        window.focusOnDeliver = function(lat, lng) {
            if (lat && lng) {
                map.setView([lat, lng], 16);
            }
        };

        // Helper function to focus on order
        window.focusOnOrder = function(reference) {
            if (orderMarkers[reference]) {
                map.setView(orderMarkers[reference].getLatLng(), 16);
                orderMarkers[reference].openPopup();
            }
        };

            // Auto-refresh every 30 seconds
            setInterval(() => {
                location.reload();
            }, 30000);
        }); // End of DOMContentLoaded
    </script>
{% endblock %}
