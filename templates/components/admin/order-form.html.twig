<div {{ attributes }}>
    {{ form_start(form, { attr: {
        class: 'space-y-6',
        'id': 'order-form',
        'data-controller': 'form-collection'
    } }) }}

    {# Order Details Section #}
    <div class="space-y-4">
        <div class="flex items-center gap-2 pb-2 border-b">
            <twig:ux:icon name="lucide:file-text" class="h-5 w-5 text-primary"/>
            <h3 class="text-lg font-semibold">Order Details</h3>
        </div>
        <div class="grid gap-4 md:grid-cols-2">
            <div>
                {{ form_row(form.reference, {
                    'help': 'Unique order reference number'
                }) }}
            </div>
            <div>
                {{ form_row(form.totalAmount, {
                    'help': 'Total order amount in Ariary'
                }) }}
            </div>
            <div>
                {{ form_row(form.scheduledDate, {
                    'help': 'When should this order be delivered?'
                }) }}
            </div>
            <div>
                {{ form_row(form.phone, {
                    'help': 'Customer contact number'
                }) }}
            </div>
        </div>
    </div>

    {# Status & Priority Section #}
    <div class="space-y-4">
        <div class="flex items-center gap-2 pb-2 border-b">
            <twig:ux:icon name="lucide:flag" class="h-5 w-5 text-primary"/>
            <h3 class="text-lg font-semibold">Status & Priority</h3>
        </div>
        <div class="grid gap-4 md:grid-cols-2">
            <div>
                {{ form_row(form.status, {
                    'help': 'Current order status'
                }) }}
            </div>
            <div>
                {{ form_row(form.priority, {
                    'help': 'Set delivery priority level'
                }) }}
            </div>
        </div>
    </div>

    {# Delivery Assignment Section #}
    <div class="space-y-4">
        <div class="flex items-center gap-2 pb-2 border-b">
            <twig:ux:icon name="lucide:truck" class="h-5 w-5 text-primary"/>
            <h3 class="text-lg font-semibold">Delivery Assignment</h3>
        </div>
        <div class="bg-muted/50 rounded-lg p-4 space-y-4">
            <div>
                {{ form_row(form.deliver, {
                    'help': 'Assign a delivery person to this order'
                }) }}
            </div>
            {% if form.deliver.vars.value %}
                <div class="flex items-center gap-2 p-3 bg-green-50 dark:bg-green-950/20 border border-green-200 dark:border-green-800 rounded-lg">
                    <twig:ux:icon name="lucide:check-circle" class="h-5 w-5 text-green-600 dark:text-green-400"/>
                    <span class="text-sm text-green-900 dark:text-green-100 font-medium">
                        Delivery person assigned
                    </span>
                </div>
            {% else %}
                <div class="flex items-center gap-2 p-3 bg-amber-50 dark:bg-amber-950/20 border border-amber-200 dark:border-amber-800 rounded-lg">
                    <twig:ux:icon name="lucide:alert-circle" class="h-5 w-5 text-amber-600 dark:text-amber-400"/>
                    <span class="text-sm text-amber-900 dark:text-amber-100 font-medium">
                        No delivery person assigned yet
                    </span>
                </div>
            {% endif %}
        </div>
    </div>

    {# Delivery Location Section #}
    <div class="space-y-4">
        <div class="flex items-center gap-2 pb-2 border-b">
            <twig:ux:icon name="lucide:map-pin" class="h-5 w-5 text-primary"/>
            <h3 class="text-lg font-semibold">Delivery Location</h3>
        </div>
        <div class="bg-muted/50 rounded-lg p-4">
            {{ form_row(form.location, {
                'help': 'Customer delivery address and coordinates'
            }) }}
        </div>
    </div>

    {# Order Items Section #}
    <div class="space-y-4">
        <div class="flex items-center justify-between pb-2 border-b">
            <div class="flex items-center gap-2">
                <twig:ux:icon name="lucide:shopping-cart" class="h-5 w-5 text-primary"/>
                <h3 class="text-lg font-semibold">Order Items</h3>
            </div>
            <button 
                type="button" 
                data-action="form-collection#addItem" 
                data-prototype="{{ form_widget(form.items.vars.prototype)|e('html_attr') }}"
                class="flex items-center gap-2 px-3 py-1.5 text-sm font-medium text-primary hover:bg-primary/10 rounded-md transition-colors"
            >
                <twig:ux:icon name="lucide:plus-circle" class="h-4 w-4"/>
                Add Item
            </button>
        </div>

        <div data-form-collection-target="container" class="space-y-3">
            {% if form.items|length > 0 %}
                {% for item in form.items %}
                    <div class="border rounded-lg p-4 bg-card hover:shadow-md transition-shadow" data-form-collection-target="item">
                        <div class="grid gap-4 md:grid-cols-4">
                            <div>
                                {{ form_row(item.quantity, {
                                    'label': 'Quantity'
                                }) }}
                            </div>
                            <div class="md:col-span-2">
                                {{ form_row(item.product, {
                                    'label': 'Product'
                                }) }}
                            </div>
                            <div>
                                {{ form_row(item.store, {
                                    'label': 'Store'
                                }) }}
                            </div>
                        </div>
                        <div class="mt-3 flex justify-end">
                            <button 
                                type="button" 
                                data-action="form-collection#removeItem" 
                                class="flex items-center gap-1 px-3 py-1.5 text-sm font-medium text-destructive hover:bg-destructive/10 rounded-md transition-colors"
                            >
                                <twig:ux:icon name="lucide:trash-2" class="h-4 w-4"/>
                                Remove
                            </button>
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <div class="border-2 border-dashed rounded-lg p-6 text-center hover:border-primary transition-colors">
            <twig:ux:icon name="lucide:upload" class="h-8 w-8 mx-auto mb-2 text-muted-foreground"/>
                    <p class="text-sm font-medium">No items added yet</p>
                    <p class="text-xs mt-1">Click "Add Item" to add products to this order</p>
                </div>
            {% endif %}
        </div>
    </div>

    {# Notes Section #}
    <div class="space-y-4">
        <div class="flex items-center gap-2 pb-2 border-b">
            <twig:ux:icon name="lucide:message-square" class="h-5 w-5 text-primary"/>
            <h3 class="text-lg font-semibold">Additional Notes</h3>
        </div>
        <div class="grid gap-4 md:grid-cols-2">
            <div>
                {{ form_row(form.notes, {
                    'help': 'Internal notes for staff'
                }) }}
            </div>
            <div>
                {{ form_row(form.deliveryNotes, {
                    'help': 'Special instructions for delivery person'
                }) }}
            </div>
        </div>
    </div>

    {# Hidden Turbo Frame Buttons #}
    <div class="items-center justify-center gap-2 mt-6 hidden turbo-frame:flex">
        <twig:ui:button:root href="{{ path('admin_order') }}" variant="outline">
            {{ 'Discard'|trans }}
        </twig:ui:button:root>
        <twig:ui:button:root formnovalidate>{{ 'Save Order'|trans }}</twig:ui:button:root>
    </div>

    {{ form_end(form) }}
</div>
